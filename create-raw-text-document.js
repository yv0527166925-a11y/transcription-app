const fs = require('fs');
const path = require('path');
const JSZip = require('jszip');

function escapeXml(text) {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function fixHebrewPunctuation(text) {
  text = text.replace(/\."/g, '".');
  text = text.replace(/,"/g, '",');
  text = text.replace(/;"/g, '";');
  return text;
}

async function createDocumentFromRawText() {
  try {
    const templatePath = path.join(__dirname, 'חזר מהשרת תקין 2.docx');
    const outPath = path.join(__dirname, 'parshat-ki-tavo-raw-text.docx');

    // הטקסט הגולמי של המשתמש
    let rawText = `כל הלשון, כל התורה בכל מקום. שלום וברכה מוריי ורבותיי, מתחילים את השיעור של פרשת כי תבוא תשפ"ה. והיה כי תבוא אל הארץ אשר השם אלוקיך נותן לך נחלה וירשתה וישבתה בה. ולקחת מראשית כל פרי האדמה אשר תביא מארצך אשר השם אלוקיך נותן לך ושמת בטנא. מה אומר רש"י? מה זה ולקחת מראשית כל פרי האדמה? מה אומר רש"י? אומר רש"י, יורד אדם יורד אדם לתוך שדהו ורואה תאנה שבקרה, כורך עליה גמי לסימן, ואומר, הרי זה ביכורים. אז בעצם מדובר על תאנה. אז למה כתוב מראשית כל פרי האדמה? מה? למה? אז אז תגיד פרי העץ, לא פרי האדמה. מה? שבח ארץ ישראל, נו. אתה לא כותב ארז, אתה אומר פרי האדמה. אז יש כאלה אומרים, בסדר, אבל הרי אם אתה מברך בורא פרי האדמה על בורא פרי העץ, אז יצאת ידי חובה. אבל החיד"ו לא מקבל את התירוץ הזה, והחיד"ו אומר, החיד"ו אומר, שאני אומר תודה רבה גם על האדמה. לכן פרי האדמה. ולכן זה אומרים על פרי האדמה ולא פרי העץ כדי להזכיר גם את האדמה עצמה. הרב אור החיים הקדוש אומר שיש כאן רמז, רמז לעניין של הביאה לעולם העליון אחרי 120. והיה כי תבוא אל הארץ אשר השם אלוקיך נותן לך, לך נחלה, זה הולך על הארץ העליונה, אחרי 120. ואז מה? ולקחת מראשית כל פרי האדמה. מה זה ראשית כל פרי האדמה? פרי האדמה, פרי העולם הזה, מה הוא? המצוות. ראשית, הכוונה המצוות הכי טובות שעשית. ועם זה, תבוא לפני השם. ולאן תבוא? אל הכהן. מי זה הכהן? רגע, לפני כן ושמתה בטנא. מה זה ושמתה בטנא? 60 מסכתות. ולמה 60 מסכתות? אז הוא אומר, כי אם אדם עושה את המצוות לפי איך שחז"ל פירשו, טוב מאוד. ואם לא, ישרף הוא והם. ומה זה באת אל הכהן? אז הוא אומר, זה הכוונה מיכאל. מיכאל המלאך שעומד ומקריב נשמות הצדיקים לפני הקדוש ברוך הוא. עומד ומקריב נשמות הצדיקים לפני הקדוש ברוך הוא, וזה הכוונה ואחרי זה, וענית ואמרת הלאה.

אחרי כל העניין הזה, אז בא אה רב שמחה זיסל זיו, הסבא מקלם, הוא אומר, שימו לב בעמוד 10. אומר, אדם שפניו מועדות לשמחת חתונה, גם אם הדרך עצמה אינה קלה ונוחה, הרי הוא שמח וטוב לב. כיוצא בזה, האדם בחייו מתקדם כל הזמן לקראת העולם הבא. ולכן, עליו להיות בשמחה. ואם איננו בשמחה, הרי זה סימן שיש לו ממה לחשוש. אם על פי האור החיים הקדוש הזה שמדברים על אז מה אומר הסבא מקלם, כל הלשון אם אדם הולך לחתונה של הבת שלו, אפילו אם דורכים עליו וזה כואב לו, לא קרה כלום. אז ככה אומר צריך להיות העולם הזה. אם אדם יודע שהוא הולך לקראת העולם הבא והוא הולך למקום הכי טוב, אז הדרך גם צריכה להיות בשמחה. וזה וזה אם לא קורה, סימן ש המצב לא טוב.

דרך אגב, עכשיו כשבאתי לפה, אמר לי הרב יעקב ישראל פה, זה זה שמסדר פה את ה אז הוא אמר לי שיש בחדר קפה, שיש בבית כנסת חדר קפה. אז היה שם פתק אם לכלכת, סימן שאתה אדם. אם לא ניקית, אתה לא בן אדם. אז מישהו אמר, אותו הדבר לגבי החודש אלול. אם עשית עבירות, סימן שאתה בן אדם, אבל אם לא חזרת בתשובה, סימן שאתה לא בן אדם. יפה.

ובאת אל הכהן אשר יהיה בימים ההם ואמרת אליו, ואחרי כל מה שאתה אומר, אתה מבקש מהקדוש ברוך הוא, השקיפה ממעון קודשך השקיפה ממעון קודשך מן השמיים וברך את עמך את ישראל ואת האדמה אשר נתת לנו, כאשר נשבעת לאבותינו, ארץ זבת חלב ודבש. עכשיו, במפרשים כתוב שהשקיפה פירושו, אה, כאילו כתוב כאן במילה השקיפה זה שתי מילים. הסק יפה. הסק, שאדם לובש שק, זה יפה לו, שהוא עושה תשובה. השאלה היא, אז מה זה קשור להשקיפה ממעון קודשך מן השמיים? אז על זה כותב הגבעת שאול, רב שאול ברך, אומר הגבעת שאול, השקיפה ממעון קודשך, עסק יפה, אבל בתנאי אחד, שרק השם רואה אותו. אם אדם לובש שק ומראה לכולם את השק, אז זה לא אין בזה כלום. כן. אמרו על אחד שרצה להתפאר, אז הוא אמר אה, תלך לחדר שלי ב בעליית הגג, איפה שאני עושה תיקון חצות, אז שמה, בזה, מתחת לספרים של הקבלה שהיינו לומד בלילה, אז אה אז זה הכוונה. הסק יפה, אבל בתנאי שזה השקיפה ממעון קודשך מן השמיים. שרק השם רואה את זה.

עכשיו יש כאן את הבעל הטורים שדיברנו עליו המון פעמים, וכל פעם צריכים לחזור עליו מחדש, מפני שהיצר הרע של דיבורים בתפילה הוא נורא ואיום. אומר בעל הטורים בפרק כ"ו פסוק י"ט, ולתתך עליון על כל הגויים אשר עשה לתהילה ולשם ולתפארת. אומר הבעל הטורים, לתהילה, לשם ולתפארת, כלומר, מה שישראל משבחים ומהללים לשם, הוא להם לתפארת. והיינו דאמרינן, עתיד הקדוש ברוך הוא להיות עטרה בראש כל צדיק וצדיק. שאותה עטרה שמעטרים לקדוש ברוך הוא בתפילתם, מחזירה להם. אבל, מי ששח שיחת חולין בבית הכנסת, מקיפים לו כל גופו בקוצים, לכך שיר השירים לית, וכנגדו ככל עשירים. דיברנו כבר על הבעל הטורים הזה הרבה פעמים. נדבר פה על החומרה של דיבורים בבית הכנסת.

אבל השנה יש לנו חידוש ששלח הרב בן ציון סנה. הוא מביא שהרמב"ם, כשהגיע למצרים, החליט לבטל את תפילת העמידה. למה? כי הוא ראה בתפילת העמידה. רק הש"ץ יגיד בקול וכולם יתפללו איתו. אז זאת אומרת, ביטל את החזרה, אבל כן. הוא ביטל את החזרה. ולמה הוא ביטל? כי הוא ראה שמדברים. יושבים מהארצות ועושים מה שבא להם. בזבוז זמן. כן, חבל על הזמן הזה, הם יכולים להספיק כמה עסקים בינתיים. אז הוא ביטל את חזרה את הש"ץ. אה? איך זה חזר? איך זה חזר? בדורות שאחרי הרמב"ם הגיע לשמה רדבז. והרדבז ראה שכבר הסיבה של התקנה ירדה והיה לו עוד סיבות כנראה, והוא החזיר את זה. הרב עובדיה דן מה הדין במקומות שמדברים? האם לבטל את חזרת הש"ץ? ככה הוא מביא פה בעמוד 22, שהרב עובדיה דן בזה. והוא כותב בשוט בשוט יכווה דעת, מאריך בזה בטוב טעם ודעת ומביא עוד אחרונים רבים, כדוגמת שוט מים חיים, וכן דברי רבנו יוסף חיים בשוט ב בשוט פעולת צדיק, וכן בשוט השמיים החדשים, בשוט קריאת חנה דוד, ו קיצור, כל המקומות האלה, ואולם בסוף הוא כותב, הרב עובדיה, ואולם נראה שגם הם לא דיברו אלא במקומות שאינם בני תורה, ורוב הקהל היו עמי הארץ שמשחקים שיחה בטלה בבית הכנסת בשעת חזרת התפילה. נגד ההלכה הפסוקה בשולחן ערוך. אבל למאי שמה? למאי הוא כותב ובסוף דבריו מסיים, לפי כך, יש לנהוג בכל הקהילות בארץ ישראל לעשות חזרה גם בתפילת מוסף של שבת ויום טוב, כתקנת חז"ל. ומאחר שמנהג רוב הקהילות בארץ ישראל לעשות חזרה כדין התלמוד, לכן אין לשנות ממנהגי ירושלים וארץ ישראל, כי מציון תצא תורה ודבר השם מירושלים, ולא לבטל. אבל רואים כמה חמור הדבר הזה שחשבו לבטל. חמור מאוד. צריך להיזהר. היצר הרע הוא גדול מאוד. צריכים להיזהר.

יש קהילות שמבטלים את זה? זה בגלל שהם ממהרים. לא בגלל שהדיבורים. אין להם זמן לזה. פעם הייתי, היה, היה יהודי אחד שאח שלי ניסה לקרב אותו, או אולי קירב אותו, לא יודע בדיוק. בכל אופן, הוא עשה בר מצווה, והזמין גם אותנו. אז הלכתי עם אשתי, אבל שהגענו לשם, נכנסנו פנימה, אנחנו רואים שזה בית כנסת רפורמי. אז ברחנו משם. אבל בחוץ היה לוח מודעות. אז היה מודעה ככה, עקב מיעוט המשתתפים בתפילות ליל שבת, הוחלט לבטל את התפילה. לגבי תפילות של שבת בבוקר, מבקשים לעשות תורנות כדי שלא נצטרך לבטל גם את זה. זה מזכיר לי את מה שאתה אומר, שממהרים, אז מבטלים את החזרת הש"ץ.

ובאו עליך כל הברכות האלה והשיגוך. למה? מישהו בורח מהברכות שצריך להשיג אותו? ובאו עליך כל הברכות האלה והשיגוך. מה, לאן אני בורח? אבל כאן זה לא כבוד, זה מדובר על הברכות. אף אחד לא מסרב לברכות. יש דבר כזה שנקרא, שאדם יש לו פתאום נפל עליו נגיד מפעל הפיס. פתאום קיבל הרבה כסף, אבל אין לו מה לעשות עם זה. למה? הוא רוצה לנסוע קצת לחוץ לארץ, הרופא לא מרשה לו, הלב שלו לא בסדר, הוא לא מרשה לו לטפס עם המטוס. הוא רוצה לאכול משהו טוב, אומר לו הרופא לא, יש לך אולקוס, אל תאכל את זה. הוא רוצה זה, לכן הוא אומר החידושי הריים, ובאו עליך כל הברכות האלה והשיגוך, שזה ישיג אותך הברכות, שיהיה לך מה לעשות עם הברכות.`;

    // מתקנים פיסוק
    rawText = fixHebrewPunctuation(rawText);

    // מחלקים לפסקאות לפי שורות ריקות בלבד
    const paragraphs = rawText
      .replace(/\r\n/g, '\n')
      .replace(/\n{3,}/g, '\n\n')
      .trim()
      .split(/\n\s*\n/)
      .filter(p => p.length > 0);

    const zip = new JSZip();
    const buffer = fs.readFileSync(templatePath);
    await zip.loadAsync(buffer);

    console.log('📖 יוצר מסמך מטקסט גולמי על פרשת כי תבוא...');

    // מתקנים הגדרות שפה
    if (zip.files['word/styles.xml']) {
      let stylesXml = await zip.file('word/styles.xml').async('string');
      stylesXml = stylesXml.replace(/w:val="ar-SA"/g, 'w:val="he-IL"');
      stylesXml = stylesXml.replace(/w:eastAsia="ar-SA"/g, 'w:eastAsia="he-IL"');
      stylesXml = stylesXml.replace(/w:bidi="ar-SA"/g, 'w:bidi="he-IL"');
      zip.file('word/styles.xml', stylesXml);
    }

    let documentXml = await zip.file('word/document.xml').async('string');

    const bodyStart = documentXml.indexOf('<w:body>') + '<w:body>'.length;
    const bodyEnd = documentXml.indexOf('</w:body>');

    let newBodyContent = '';
    paragraphs.forEach(paragraph => {
      newBodyContent += `
    <w:p w14:paraId="13B47B51" w14:textId="77777777" w:rsidR="007754CD" w:rsidRDefault="00E60846">
      <w:pPr>
        <w:jc w:val="right"/>
      </w:pPr>
      <w:r>
        <w:rPr>
          <w:lang w:val="he-IL" w:eastAsia="he-IL" w:bidi="he-IL"/>
        </w:rPr>
        <w:t>${escapeXml(paragraph)}</w:t>
      </w:r>
    </w:p>`;
    });

    const newDocumentXml = documentXml.substring(0, bodyStart) +
                          newBodyContent +
                          documentXml.substring(bodyEnd);

    zip.file('word/document.xml', newDocumentXml);

    const outBuffer = await zip.generateAsync({ type: 'nodebuffer' });
    fs.writeFileSync(outPath, outBuffer);

    console.log('✅ יצרתי מסמך מהטקסט הגולמי:', outPath);
    console.log('📊 מספר פסקאות:', paragraphs.length);
    console.log('📖 הנושא: פרשת כי תבוא - ביכורים ודיבורים בבית הכנסת');
    console.log('🔧 הגדרות: עברית תקינה + יישור לימין + פיסוק מתוקן');
    console.log('');
    console.log('📝 הטקסט הגולמי חולק ל-' + paragraphs.length + ' פסקאות על בסיס שורות ריקות בלבד');
    console.log('💬 הטקסט מכיל דיבור ישיר, ציטוטים ומעברים נושאיים טבעיים');

  } catch (error) {
    console.error('❌ שגיאה:', error);
  }
}

createDocumentFromRawText();