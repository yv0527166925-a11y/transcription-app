const fs = require('fs');
const path = require('path');
const JSZip = require('jszip');

function escapeXml(text) {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function fixHebrewPunctuation(text) {
  text = text.replace(/\."/g, '".');
  text = text.replace(/,"/g, '",');
  text = text.replace(/;"/g, '";');
  return text;
}

async function createSimchaMitzvotDocument() {
  try {
    const templatePath = path.join(__dirname, '×—×–×¨ ××”×©×¨×ª ×ª×§×™×Ÿ 2.docx');
    const outPath = path.join(__dirname, 'simcha-mitzvot-text.docx');

    // ×”×˜×§×¡×˜ ×¢×œ ×©××—×” ×‘××¦×•×•×ª
    let simchaText = `××ª ×”×©××—×” ×©×œ×• ×”×•× ××§×‘×œ ×œ×¤×™ ××™×“×ª ×”×©××—×” ×‘××¦×•×•×ª".×× ××“× ×¢×•×©×” ××ª ×”××¦×•×•×ª ×¢× ×¢×•×œ, ×›××©××•×™, ×”×•× ××¨×’×™×© ×©×”×•× ×¨×•×¦×” ×œ×‘×¨×•×— ××”××¦×•×•×”, ×‘×—×™×™× ×©×œ×• ×”×•× ×™×›×•×œ ×œ×”×™×•×ª ××™×œ×™×•× ×¨, ××‘×œ ×›×œ ×”×–××Ÿ ×”×•× ×œ×—×•×¥, ××£ ×¤×¢× ×”×•× ×œ× ×©××—. ×”×•× ×ª××™×“ ××¨×’×™×© ×›×‘×“, ×›×‘×“×•×ª. ×–×” ××¤×¨×™×¢ ×œ×•, ×•××” ×™×”×™×” ×•××” ×¤×” ×•××” ×©×. ××‘×œ ×× ××“× ×—×™ ×¢× ×©××—×” ×‘××¦×•×•×ª, × ×•×ª×Ÿ ×œ×• ×”×§×“×•×© ×‘×¨×•×š ×”×•× ×©××—×” ×‘×œ×‘. ×©××ª× ×œ×‘ ×©××™ ×©×”×•×œ×š ×œ×™×, ×œ×©×¤×ª ×”×™×, ×”×•× ×ª××™×“ × ×¨×’×¢? ×›×©××“× ×”×•× ×¢×¦×‘× ×™ ×§×¦×ª, ×”×•× ×¨×•×¦×”, ×”×•× ×™×•×©×‘ ×¢×œ ×—×•×£ ×”×™×, ×”×•× ×¨×§ ×™×•×©×‘ ×¢×œ ×—×•×£ ×”×™×, ×”×•× × ×¨×’×¢. ××” ×™×© ×‘×™× ×©×”×™× ×’×•×¨× ×œ×‘×Ÿ ××“× ×©×”×•× ×œ×—×•×¥ ×•×˜×¨×•×“ ×œ×”×™×¨×’×¢? ××” ×™×© ×©××”? ××” ×”×¡×•×“? ×”×’×œ×™× ×©×œ ×”×™× ×¢×•×©×™× ×¨×¢×©. ××•××¨ ×”"××•×”×‘ ×™×©×¨××œ" ×××¤×˜×: "×‘×™× ×™×© ××œ×—". ×”×•× ×©×•××œ ×¢×•×“ ×©××œ×”. ×”×•× ××•××¨, "×§×•×“× ×›×œ, ×œ××” ×”××™× ××œ×•×—×™× ×‘×™×?" ××™×©×”×• ×¤×¢× ×—×©×‘ ×œ××” ×”××™× ×‘×™× ×”× ××œ×•×—×™×? ×©××œ×” ×©×œ×™×©×™×ª ×©×”×•× ×©×•××œ. ××•××¨×™× ×—×–"×œ ×‘××¡×›×ª ×“×¨×š ××¨×¥:

"×§×— ×§×“×¨×”, ×ª×›×™×Ÿ ×‘×” ××ª ×”×‘×©×¨ ×”×›×™ ×˜×•×‘ ×‘×¢×•×œ×. ××œ ×ª×©×™× ×‘×” ×˜×™×¤×” ×©×œ ××œ×—, ××ª×” ×œ× ×™×›×•×œ ×œ××›×•×œ. ××™×Ÿ ×©×•× ×˜×¢×. ××ª ×”××œ×— ×œ×‘×“ ×ª××›×œ? ×”×©× ×™×¨×—×, ××™ ××¤×©×¨ ×œ××›×•×œ ××•×ª×•. ××ª×” ×©× ×˜×™×¤×” ××œ×— ×‘××•×›×œ, ×”××•×›×œ ××©×ª× ×”, × ×”×™×” ×˜×¢×™×. ××”, ××” ×”×¡×•×“ ×©×œ ×”××œ×— ×©×”×•×¤×š ××ª ×”××•×›×œ ×œ×˜×¢×™×? ××•××¨ ×”"××•×”×‘ ×™×©×¨××œ" ×××¤×˜×: "×”×™× ×‘×•×›×”". ×›×©×‘×•×›×™× ×™×© ××œ×—, ×”×“××¢×•×ª ×”× ××œ×•×—×•×ª. ×›×œ ×”×¨×¢×© ×©×™×© ×‘×™× ×”×•× ×‘×•×›×”. ×œ××”? ×”×¨×—×™×§×• ××•×ª×• ××Ÿ ×”×§×“×•×© ×‘×¨×•×š ×”×•×. ×”×•× ×”×™×” ×‘×©××™×™×. ×œ××” ×”×¤×¨×™×“×• ××ª ×”××™× ×”×¢×œ×™×•× ×™× ××”××™× ×”×ª×—×ª×•× ×™×? ×•×”×™× ××‘×™× ×’×œ×™×, ×”×•× ×¨×•×¦×” ×œ×”×—×¨×™×‘ ××ª ×”×¢×•×œ×, ×œ×”×—×–×™×¨ ××•×ª×• ×œ×ª×•×”×• ×•×‘×•×”×• ×›×“×™ ×©×”×•× ×™×—×–×•×¨ ×œ×”×™×•×ª ×§×¨×•×‘ ×œ×¨×™×‘×•× ×• ×©×œ ×¢×•×œ×. ×× ××ª×” × ××¦× ×œ×™×“ ××™ ×©×¨×•×¦×” ×œ×”×ª×§×¨×‘ ×œ×¨×™×‘×•× ×• ×©×œ ×¢×•×œ×, ××ª×” ×›×‘×¨ × ×¨×’×¢. ×¢×œ ××—×ª ×›××” ×•×›××” ×× ××ª×” ××ª×§×¨×‘ ×œ×¨×™×‘×•× ×• ×©×œ ×¢×•×œ×. ×× ××ª×” ×œ×•×§×— ××œ×— ×©×œ ×“××¢×•×ª, ×©×œ, ××™×š ×¢×•×©×™× ××œ×—? ×œ×•×§×—×™× ××ª ×”×™×, ×¢×•×©×™× ×—×¨×™×¦×™× ×œ×™×“ ×”×™×, ×™×•×¦××™× ×”××™×, ×”×©××© ×××“×” ××ª ×”××™×, × ×©××¨ ××œ×—. ×–×” ××©×¨×¤×•×ª ××œ×—. ××ª×” ×œ×•×§×— ××œ×— ×©×œ ×“××¢×•×ª, ×©×œ ×§×¨×‘×ª ×”×©×, ×©×œ ×©××™×¤×” ×œ×”×ª×§×¨×‘ ×œ×”×©×, ×–×” ×××ª×§ ×œ×š ××ª ×›×œ ×”××•×›×œ. ×–×” × ×•×ª×Ÿ ×œ×š ×©××—×”, × ×•×ª×Ÿ ×œ×š ××ª×™×§×•×ª, × ×•×ª×Ÿ ×œ×š ×˜×¢× ×‘×—×™×™×. ×× ××“× ××—×¤×© ×ª×¢× ×•×’, ××—×¤×© ×©××—×”, ××ª ×”×©××—×” ×”×•× ××©×™×’ ×‘×¢×‘×•×“×ª ×”×©×. "×•×”×™×” ×× ×ª×¢×©×” ××ª ×”××¦×•×•×ª ×‘×©××—×”", ××¤×™×œ×• ×©×–×” ×¢×§×‘, ××¤×™×œ×• ×©×–×” ××¦×•×•×” ×©××“× ×“×© ×‘×¢×§×‘×™×•. ××¦×•×•×” ×§×œ×”, ×›××™×œ×• ××” ×”××¦×•×•×” ×”×–××ª ×ª×¢×œ×” ××• ×ª×•×¨×™×“? ×–×• ×”×˜×¢×•×ª. ×”××¦×•×•×ª ×”××œ×•, ×”× ×¢×•×©×™× ××ª ×”××“×. ××“× ×©×™×© ×œ×• ×¤×œ××¤×•×Ÿ, ×œ××©×ª×• ×”×•× ××ª×§×©×¨ ×—××© ×¤×¢××™×, ×¢×©×¨ ×¤×¢××™× ×‘×™×•× ××™× ×™××•×. ××ª ×¦×¨×™×›×” ××ª ×–×”, ××ª ×¦×¨×™×›×” ××ª ×–×”, ××ª ×¦×¨×™×›×” ××ª ×–×”. ×œ××”? ×›×™ ×”×•× ×§×©×•×¨ ××œ×™×”. ×œ×‘×•×¡ ×©×œ×• ×”×•× ×œ× ××ª×§×©×¨. ×›××” ×©×™×•×ª×¨, ×¢×“×™×£ ×©×”×•× ×œ× ×™×“×‘×¨ ××™×ª×•. ×× ×”×•× ××•×›×¨×—, ×”×•× ××“×‘×¨ ××™×ª×•. ×”×•× ××•××¨, ×™×© ×‘× ×™ ××“× ×©×™×© ×œ×”× ××™×–×” ×¨×’×¢ ×©×”× ××ª×¨×•×××™×, ×¨×’×¢ ×©×”× ×¢×•×©×™× ××™×–×” ××¦×•×•×”. ××‘×œ ××™×Ÿ ×œ×• ×§×©×¨. ×›×©×”×•× ××•×›×¨×—, ×”×•× ××“×‘×¨ ×¢× ×”×‘×•×¡, ×¢× ×”×§×“×•×© ×‘×¨×•×š ×”×•×. ××‘×œ ×™×© ××“× ×©××¨×’×™×©, "××©×ª ×—×™×œ ××™ ×™××¦×?" ×›× ×¡×ª ×™×©×¨××œ ××•××¨×ª ×œ×§×“×•×© ×‘×¨×•×š ×”×•×, "×× ×—× ×• ××©×ª ×—×™×œ ×›×‘×™×›×•×œ.

×× ×—× ×• ×¨×•×¦×™× ×§×©×¨". ×•×§×©×¨ ×–×” ×›×œ ×”××¦×•×•×ª ×©××“× ×“×© ×‘×¢×§×‘×™×•, ×›×œ ×”××¦×•×•×ª ×©× ×¢×©×•×ª ×‘×”×œ×™×›×” ×”×¨×’×™×œ×” ×›×œ ×™×•×.100 ×¤×¢××™× ×‘×™×•× ×× ×™ ××‘×¨×š. 100 ×¤×¢××™× ×‘×™×•× ×”×¨××ª×™ ×˜×œ×¤×•×Ÿ ×œ×§×“×•×© ×‘×¨×•×š ×”×•× ×•×“×™×‘×¨×ª×™ ××™×ª×•. ×× ×™ ×¢× ×™×ª×™ 90 ×××Ÿ. ×× ×™ ×¢× ×™×ª×™ 90 ×××Ÿ ×‘×™×•×. ×“×™×‘×¨×ª×™, ×—×©×‘×ª×™ ×××•× ×”, ×©×© ××¦×•×•×ª ×ª××™×“×™×•×ª, ×¢×©×™×ª×™ ×”×ª×—×–×§×•×ª, ×¤×” ×¢×©×™×ª×™ ×—×¡×“, ×¤×” ×¢×©×™×ª×™ ××¦×•×•×”, ×¤×” ×¢×©×™×ª×™ ×¤×¢×•×œ×”. ×”×§×©×¨ ×”×–×” ×¢× ×¨×™×‘×•× ×• ×©×œ ×¢×•×œ×, ×–×” ×¢×•×©×” ××ª ×”××“×. ×–×” ××” ×©× ×•×ª×Ÿ ×œ×• ×ª××™×“ ××ª ×”×‘×¨×›×”. "×•×”×™×” ×¢×§×‘ ×ª×©××¢×•×Ÿ". ××” ××‘×˜×™×—×” ×œ×• ×”×ª×•×¨×”? ×¢×©×¨ ×‘×¨×›×•×ª × ×¤×œ××•×ª ××‘×˜×™×—×” ×œ×• ×”×ª×•×¨×”. ×‘×•××• ×ª×¡×ª×›×œ×•. ×›×š ××•××¨ ×”×’××•×Ÿ ××•×•×™×œ× ×: "××™ ×©××§×¤×™×“ ×¢×œ ××¦×•×•×ª ×©××“× ×“×© ×‘×¢×§×‘×™×•, ×¢×©×¨ ×‘×¨×›×•×ª ××•××¨×ª ×œ×• ×”×ª×•×¨×”". "×•××”×‘×š", ×‘×¨×›×” ×¨××©×•× ×”. ××™ ×©×”×•× ××”×•×‘ ××¦×œ ×”×§×“×•×© ×‘×¨×•×š ×”×•×, ×™×© ×œ×• ×¤×¨×•×˜×§×¦×™×”. ×™×© ×œ×• ×¤×¨×•×˜×§×¦×™×”. ×›×©××ª×” ×§×¨×•×‘ ×œ×¨×™×‘×•× ×• ×©×œ ×¢×•×œ×, ×™×© ×œ×š ×¤×¨×•×˜×§×¦×™×”. ×¢×•×“ ××¢×˜ ×× ×™ ××“×‘×¨ ××™×ª×›× ×¢×œ ×”×•××”×‘×š ×”×–×”. ×”×‘×¨×›×” ×”×©× ×™×™×”, "×•×‘×¨×›×š". ××” ×©×ª×¢×©×”, ×ª×¦×œ×™×—. ××•××¨ ×”×§×“×•×© ×‘×¨×•×š ×”×•×, "××” ×©××ª×” ×¢×•×©×”, ××ª×” ××¦×œ×™×—". ××™ × ×•×ª×Ÿ? ×›××” ×× ×©×™× ××—×¤×©×™× ×”×¦×œ×—×”. "×•×›×œ ××©×¨ ×™×¢×©×” ×™×¦×œ×™×—". ×× ×—× ×• ×™×•×“×¢×™×, ×©×¨×™× ××ª ×”×©×™×¨ ×”×–×”. ××™×¤×” ×–×” "×•×›×œ ××©×¨"? ×‘××” ×–×” ×ª×œ×•×™ "×•×›×œ ××©×¨ ×™×¢×©×” ×™×¦×œ×™×—"? ×‘××” ×”×•× ×ª×œ×•×™? ××•××¨×ª ×”×ª×•×¨×”, ×”×•× ×ª×œ×•×™ ×× ××ª×” ×©××— ×•××§×¤×™×“ ×‘××¦×•×•×ª ×©××“× ×“×© ×‘×¢×§×‘×™×•. "×•×”×¨×‘×š". ×”×•× ××•××¨, ×œ× ×¨×§ ×©×ª×¦×œ×™×—, ××” ×©×ª×¦×œ×™×— ×™×”×™×” ×œ×š ×¨×™×‘×•×™. ×™×”×™×” ×œ×š ×”×¦×œ×—×” ×‘×¦×•×¨×” ×›×–××ª ×©×”×¢×¡×§×™× ×©×œ×š, ×”×“×‘×¨×™× ××¦×œ×š, ×›×•×œ× ×™×ª×¨×‘×•. ××ª×” ×—×•×©×‘ ×©×¨×§ ××ª×” ×•×”×¤×¨× ×¡×” ×ª×ª×¨×‘×”? "×•×‘×¨×š ×¤×¨×™ ×‘×˜× ×š". ×× ×™ ×—×•×©×‘ ×©×–×” ×”×‘×¨×›×”... ×’×“×•×œ×”, ×”×™×œ×“×™× ×©×œ×š ×™×”×™×• ××•×¦×œ×—×™×. ×¤×¨×™ ×‘×˜× ×š, ×”×™×œ×“×™× ×©×œ×š ×™×ª× ×• ×œ×š × ×—×ª ×™×”×•×“×™×ª ×××™×ª×™×ª. ×œ××”? ××ª×” ×§×©×•×¨ ×¢× ×¨×™×‘×•× ×• ×©×œ ×¢×•×œ×, ××ª×” ×§×©×•×¨ ×¢× ×¨×™×‘×•× ×• ×©×œ ×¢×•×œ×, ××ª×” ×™×›×•×œ ×œ×‘×§×© ×‘×§×©×•×ª ×’×“×•×œ×•×ª. ×’× ××ª ×”×™×œ×“×™×. ×”××”×¨×™"×“ ××‘×¢×œ×– ××•××¨, ×›×ª×•×‘ ×‘×¤×¨×©×ª ×”×©×‘×•×¢ "×•×œ×™××“×ª× ××•×ª× ××ª ×‘× ×™×›×".`;

    // ××ª×§× ×™× ×¤×™×¡×•×§
    simchaText = fixHebrewPunctuation(simchaText);

    const paragraphs = simchaText
      .replace(/\r\n/g, '\n')
      .replace(/\n{3,}/g, '\n\n')
      .trim()
      .split(/\n\s*\n/)
      .filter(p => p.length > 0);

    const zip = new JSZip();
    const buffer = fs.readFileSync(templatePath);
    await zip.loadAsync(buffer);

    console.log('ğŸ“– ×™×•×¦×¨ ××¡××š ×¢×œ ×©××—×” ×‘××¦×•×•×ª...');

    // ××ª×§× ×™× ×”×’×“×¨×•×ª ×©×¤×”
    if (zip.files['word/styles.xml']) {
      let stylesXml = await zip.file('word/styles.xml').async('string');
      stylesXml = stylesXml.replace(/w:val="ar-SA"/g, 'w:val="he-IL"');
      stylesXml = stylesXml.replace(/w:eastAsia="ar-SA"/g, 'w:eastAsia="he-IL"');
      stylesXml = stylesXml.replace(/w:bidi="ar-SA"/g, 'w:bidi="he-IL"');
      zip.file('word/styles.xml', stylesXml);
    }

    let documentXml = await zip.file('word/document.xml').async('string');

    const bodyStart = documentXml.indexOf('<w:body>') + '<w:body>'.length;
    const bodyEnd = documentXml.indexOf('</w:body>');

    let newBodyContent = '';
    paragraphs.forEach(paragraph => {
      newBodyContent += `
    <w:p w14:paraId="13B47B51" w14:textId="77777777" w:rsidR="007754CD" w:rsidRDefault="00E60846">
      <w:pPr>
        <w:jc w:val="right"/>
      </w:pPr>
      <w:r>
        <w:rPr>
          <w:lang w:val="he-IL" w:eastAsia="he-IL" w:bidi="he-IL"/>
        </w:rPr>
        <w:t>${escapeXml(paragraph)}</w:t>
      </w:r>
    </w:p>`;
    });

    const newDocumentXml = documentXml.substring(0, bodyStart) +
                          newBodyContent +
                          documentXml.substring(bodyEnd);

    zip.file('word/document.xml', newDocumentXml);

    const outBuffer = await zip.generateAsync({ type: 'nodebuffer' });
    fs.writeFileSync(outPath, outBuffer);

    console.log('âœ… ×™×¦×¨×ª×™ ××¡××š ×¢×œ ×©××—×” ×‘××¦×•×•×ª:', outPath);
    console.log('ğŸ“Š ××¡×¤×¨ ×¤×¡×§××•×ª:', paragraphs.length);
    console.log('ğŸ“– ×”× ×•×©×: ×©××—×” ×‘××¦×•×•×ª - ×”×™× ×©×‘×•×›×” - ×¢×©×¨ ×‘×¨×›×•×ª');
    console.log('ğŸ”§ ×”×’×“×¨×•×ª: ×¢×‘×¨×™×ª ×ª×§×™× ×” + ×™×™×©×•×¨ ×œ×™××™×Ÿ + ×¤×™×¡×•×§ ××ª×•×§×Ÿ');

  } catch (error) {
    console.error('âŒ ×©×’×™××”:', error);
  }
}

createSimchaMitzvotDocument();