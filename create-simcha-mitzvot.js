const fs = require('fs');
const path = require('path');
const JSZip = require('jszip');

function escapeXml(text) {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function fixHebrewPunctuation(text) {
  text = text.replace(/\."/g, '".');
  text = text.replace(/,"/g, '",');
  text = text.replace(/;"/g, '";');
  return text;
}

async function createSimchaMitzvotDocument() {
  try {
    const templatePath = path.join(__dirname, 'חזר מהשרת תקין 2.docx');
    const outPath = path.join(__dirname, 'simcha-mitzvot-text.docx');

    // הטקסט על שמחה במצוות
    let simchaText = `את השמחה שלו הוא מקבל לפי מידת השמחה במצוות".אם אדם עושה את המצוות עם עול, כמשאוי, הוא מרגיש שהוא רוצה לברוח מהמצווה, בחיים שלו הוא יכול להיות מיליונר, אבל כל הזמן הוא לחוץ, אף פעם הוא לא שמח. הוא תמיד מרגיש כבד, כבדות. זה מפריע לו, ומה יהיה ומה פה ומה שם. אבל אם אדם חי עם שמחה במצוות, נותן לו הקדוש ברוך הוא שמחה בלב. שמתם לב שמי שהולך לים, לשפת הים, הוא תמיד נרגע? כשאדם הוא עצבני קצת, הוא רוצה, הוא יושב על חוף הים, הוא רק יושב על חוף הים, הוא נרגע. מה יש בים שהים גורם לבן אדם שהוא לחוץ וטרוד להירגע? מה יש שמה? מה הסוד? הגלים של הים עושים רעש. אומר ה"אוהב ישראל" מאפטא: "בים יש מלח". הוא שואל עוד שאלה. הוא אומר, "קודם כל, למה המים מלוחים בים?" מישהו פעם חשב למה המים בים הם מלוחים? שאלה שלישית שהוא שואל. אומרים חז"ל במסכת דרך ארץ:

"קח קדרה, תכין בה את הבשר הכי טוב בעולם. אל תשים בה טיפה של מלח, אתה לא יכול לאכול. אין שום טעם. את המלח לבד תאכל? השם ירחם, אי אפשר לאכול אותו. אתה שם טיפה מלח באוכל, האוכל משתנה, נהיה טעים. מה, מה הסוד של המלח שהופך את האוכל לטעים? אומר ה"אוהב ישראל" מאפטא: "הים בוכה". כשבוכים יש מלח, הדמעות הם מלוחות. כל הרעש שיש בים הוא בוכה. למה? הרחיקו אותו מן הקדוש ברוך הוא. הוא היה בשמיים. למה הפרידו את המים העליונים מהמים התחתונים? והים מביא גלים, הוא רוצה להחריב את העולם, להחזיר אותו לתוהו ובוהו כדי שהוא יחזור להיות קרוב לריבונו של עולם. אם אתה נמצא ליד מי שרוצה להתקרב לריבונו של עולם, אתה כבר נרגע. על אחת כמה וכמה אם אתה מתקרב לריבונו של עולם. אם אתה לוקח מלח של דמעות, של, איך עושים מלח? לוקחים את הים, עושים חריצים ליד הים, יוצאים המים, השמש מאדה את המים, נשאר מלח. זה משרפות מלח. אתה לוקח מלח של דמעות, של קרבת השם, של שאיפה להתקרב להשם, זה ממתק לך את כל האוכל. זה נותן לך שמחה, נותן לך מתיקות, נותן לך טעם בחיים. אם אדם מחפש תענוג, מחפש שמחה, את השמחה הוא משיג בעבודת השם. "והיה אם תעשה את המצוות בשמחה", אפילו שזה עקב, אפילו שזה מצווה שאדם דש בעקביו. מצווה קלה, כאילו מה המצווה הזאת תעלה או תוריד? זו הטעות. המצוות האלו, הם עושים את האדם. אדם שיש לו פלאפון, לאשתו הוא מתקשר חמש פעמים, עשר פעמים ביום מינימום. את צריכה את זה, את צריכה את זה, את צריכה את זה. למה? כי הוא קשור אליה. לבוס שלו הוא לא מתקשר. כמה שיותר, עדיף שהוא לא ידבר איתו. אם הוא מוכרח, הוא מדבר איתו. הוא אומר, יש בני אדם שיש להם איזה רגע שהם מתרוממים, רגע שהם עושים איזה מצווה. אבל אין לו קשר. כשהוא מוכרח, הוא מדבר עם הבוס, עם הקדוש ברוך הוא. אבל יש אדם שמרגיש, "אשת חיל מי ימצא?" כנסת ישראל אומרת לקדוש ברוך הוא, "אנחנו אשת חיל כביכול.

אנחנו רוצים קשר". וקשר זה כל המצוות שאדם דש בעקביו, כל המצוות שנעשות בהליכה הרגילה כל יום.100 פעמים ביום אני מברך. 100 פעמים ביום הרמתי טלפון לקדוש ברוך הוא ודיברתי איתו. אני עניתי 90 אמן. אני עניתי 90 אמן ביום. דיברתי, חשבתי אמונה, שש מצוות תמידיות, עשיתי התחזקות, פה עשיתי חסד, פה עשיתי מצווה, פה עשיתי פעולה. הקשר הזה עם ריבונו של עולם, זה עושה את האדם. זה מה שנותן לו תמיד את הברכה. "והיה עקב תשמעון". מה מבטיחה לו התורה? עשר ברכות נפלאות מבטיחה לו התורה. בואו תסתכלו. כך אומר הגאון מווילנא: "מי שמקפיד על מצוות שאדם דש בעקביו, עשר ברכות אומרת לו התורה". "ואהבך", ברכה ראשונה. מי שהוא אהוב אצל הקדוש ברוך הוא, יש לו פרוטקציה. יש לו פרוטקציה. כשאתה קרוב לריבונו של עולם, יש לך פרוטקציה. עוד מעט אני אדבר איתכם על הואהבך הזה. הברכה השנייה, "וברכך". מה שתעשה, תצליח. אומר הקדוש ברוך הוא, "מה שאתה עושה, אתה מצליח". מי נותן? כמה אנשים מחפשים הצלחה. "וכל אשר יעשה יצליח". אנחנו יודעים, שרים את השיר הזה. איפה זה "וכל אשר"? במה זה תלוי "וכל אשר יעשה יצליח"? במה הוא תלוי? אומרת התורה, הוא תלוי אם אתה שמח ומקפיד במצוות שאדם דש בעקביו. "והרבך". הוא אומר, לא רק שתצליח, מה שתצליח יהיה לך ריבוי. יהיה לך הצלחה בצורה כזאת שהעסקים שלך, הדברים אצלך, כולם יתרבו. אתה חושב שרק אתה והפרנסה תתרבה? "וברך פרי בטנך". אני חושב שזה הברכה... גדולה, הילדים שלך יהיו מוצלחים. פרי בטנך, הילדים שלך יתנו לך נחת יהודית אמיתית. למה? אתה קשור עם ריבונו של עולם, אתה קשור עם ריבונו של עולם, אתה יכול לבקש בקשות גדולות. גם את הילדים. המהרי"ד מבעלז אומר, כתוב בפרשת השבוע "ולימדתם אותם את בניכם".`;

    // מתקנים פיסוק
    simchaText = fixHebrewPunctuation(simchaText);

    const paragraphs = simchaText
      .replace(/\r\n/g, '\n')
      .replace(/\n{3,}/g, '\n\n')
      .trim()
      .split(/\n\s*\n/)
      .filter(p => p.length > 0);

    const zip = new JSZip();
    const buffer = fs.readFileSync(templatePath);
    await zip.loadAsync(buffer);

    console.log('📖 יוצר מסמך על שמחה במצוות...');

    // מתקנים הגדרות שפה
    if (zip.files['word/styles.xml']) {
      let stylesXml = await zip.file('word/styles.xml').async('string');
      stylesXml = stylesXml.replace(/w:val="ar-SA"/g, 'w:val="he-IL"');
      stylesXml = stylesXml.replace(/w:eastAsia="ar-SA"/g, 'w:eastAsia="he-IL"');
      stylesXml = stylesXml.replace(/w:bidi="ar-SA"/g, 'w:bidi="he-IL"');
      zip.file('word/styles.xml', stylesXml);
    }

    let documentXml = await zip.file('word/document.xml').async('string');

    const bodyStart = documentXml.indexOf('<w:body>') + '<w:body>'.length;
    const bodyEnd = documentXml.indexOf('</w:body>');

    let newBodyContent = '';
    paragraphs.forEach(paragraph => {
      newBodyContent += `
    <w:p w14:paraId="13B47B51" w14:textId="77777777" w:rsidR="007754CD" w:rsidRDefault="00E60846">
      <w:pPr>
        <w:jc w:val="right"/>
      </w:pPr>
      <w:r>
        <w:rPr>
          <w:lang w:val="he-IL" w:eastAsia="he-IL" w:bidi="he-IL"/>
        </w:rPr>
        <w:t>${escapeXml(paragraph)}</w:t>
      </w:r>
    </w:p>`;
    });

    const newDocumentXml = documentXml.substring(0, bodyStart) +
                          newBodyContent +
                          documentXml.substring(bodyEnd);

    zip.file('word/document.xml', newDocumentXml);

    const outBuffer = await zip.generateAsync({ type: 'nodebuffer' });
    fs.writeFileSync(outPath, outBuffer);

    console.log('✅ יצרתי מסמך על שמחה במצוות:', outPath);
    console.log('📊 מספר פסקאות:', paragraphs.length);
    console.log('📖 הנושא: שמחה במצוות - הים שבוכה - עשר ברכות');
    console.log('🔧 הגדרות: עברית תקינה + יישור לימין + פיסוק מתוקן');

  } catch (error) {
    console.error('❌ שגיאה:', error);
  }
}

createSimchaMitzvotDocument();