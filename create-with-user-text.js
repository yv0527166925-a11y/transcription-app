const fs = require('fs');
const path = require('path');
const JSZip = require('jszip');

function escapeXml(text) {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

async function createWithUserText() {
  try {
    const templatePath = path.join(__dirname, 'חזר מהשרת תקין 2.docx');
    const outPath = path.join(__dirname, 'test-user-exact-text.docx');

    // הטקסט המדויק שהמשתמש הדביק
    const userText = `ברוך השם, יש לנו שמחה גדולה למלאות מקומו של אדם גדול, בנעליים מאוד גדולות, של רב דור רוזנבלום שליט"א, לבוא לדבר ביום שישי לכבוד שבת קודש. ככה לחבר את ימות החול עם ימות השבת בדברים נפלאים. בעזרת השם יתברך, אנחנו מתחילים השבוע פרשת עקב. התורה כותבת בפרשת השבוע: "והיה עקב תשמעון את המשפטים האלה ושמרתם ועשיתם אותם". אומרים חז"ל, מה זה "והיה עקב תשמעון"?

מביא רש"י: "אלו המצוות שאדם דש בעקביו". מיד נצטרך להבין, מה פירוש המילה דש? אלה המצוות הקלות. למה התורה כותבת "המצוות שאדם דש"? מה מה... אז נתחיל אולי בזה. כשאדם דש, מה זה מלאכת דש בשבת? יש לאדם חיטים, שיבולים. יש שמה מוץ, את השיבולים ויש את הגרגרים בפנים. איך מפרידים? לוקחים פרה, שמים קרש, והפרה הולכת עם הקרש, והקרש עובר ומוחץ את החיטים. מפריד בין המוץ לבין הגרגרים. כשאדם מסתכל והוא רואה פה, מה הוא רואה? הוא רואה תערובת של שיבולים, רואה מוץ ביחד עם גרגרים. נראה שלא עשינו כלום. נראה שאין פה כלום, שום דבר לא השתנה. אני רואה, היה שיבולים, נשאר שיבולים. אבל מתי אתה רואה את השינוי? מגיעה הרוח, או אתה זורק את זה ברוח, המוץ שהוא קל, עף. הגרגרים שהם כבדים, נשארים. ואז אתה רואה שמה שעשית וחשבת שלא עשית כלום, חשבת שמה שהיה זה מה שנשאר, זה טעות, פשוט אופטית, טעית. יש פה שינוי דרסטי. רוח אחת הצמיחה לך כאן גורן שלם של דגן. נתנה לך חיים, חיות, לחם, שבו נותנים לנו את החיות לאדם. אומר, ישנם הרבה מצוות, כותב רש"י, כשאדם עושה אותם, הוא עושה את המצווה והוא אומר, "פשש, אני לא מרוצה מהמצווה הזאת, נראה לי שלא הצלחתי".

הוא עושה איזה מצווה והוא מרגיש כביכול שהוא לא הצליח להתרומם על ידי אותה מצווה. אבל כשמגיע פתאום איזה רוח, מגיע ימים נוראים, הוא שומע איזה שיחה מעוררת, איזה רוממות אמיתית, אתה רואה את כל המוץ עף.

ואז אתה רואה את המילים הטובות, את המצווה שהוא עשה, את המילה הזאת שהוא שמע, מה היא עושה לו, איך היא מרוממת אותו, לאן היא מעלה אותו, לאיזה פסגות היא מביאה אותו.

אומר רש"י: "והיה עקב תשמעון". אם אתה עושה מצווה, תעשה את המצווה עם חשק. תעשה את המצווה עם שמחה. "והיה", תמיד והיה אומר האור החיים הקדוש, זה לשון שמחה".שכר מצווה בהאי עלמא ליכא". אין שכר על המצוות בעולם הזה. כך אומרת הגמרא בקידושין בדף לט עמוד ב'. אין שכר על המצוות בעולם הזה. אבל כותב החיד"א, שאם אדם מוסיף תוספת מעצמו, דהיינו הוא טורח, עושה איזה תוספת מעצמו, זה לא חיוב אותך.

זה הוא מקבל שכר גם בעולם הזה. והוא אומר, לכן כתוב "יחיינו מיומיים". אברהם אבינו הלך לעקוד את הבן שלו יצחק.

על עקידת יצחק הוא לא קיבל שכר, זה שייך לעולם הבא. אבל על היומיים של הדרך, שהוא הולך בלי לערער ובלי לטעות ולהתחרט רגע אחד, "מה אני הולך לעשות? אני הולך לעקוד את הבן שלי, איזה חילול השם יהיה פה, איזה חורבן, מה יגידו כל העולם?" הוא לא ערער, הוא הלך בשמחה.

על אותה שמחה שהוא הלך, "יחיינו". כל חיי העולם הזה אנחנו אוכלים את הברכה מהיומיים האלה. אומר השם משמואל, שזה מה שהתורה כותבת.

אם תעשה את המצוות, גם אם אתה לא מרוצה, אבל תשמח, "עשיתי מצווה, התרוממתי". על השמחה, על "והיה", אתה מקבל שכר בעולם הזה.

אפילו ששכר מצווה בהאי עלמא ליכא. את השכר על המצווה, על השמחה של המצווה, מקבל בעולם הזה. ידוע שכתוב בספרי חסידות, שכשאדם...

יש הרבה אנשים, אתה שואל אותו, "מה?" "אין לו מצב רוח". מישהו פעם חשב, בדורות הקודמים, היה להם בקושי פרנסה.

לא הייתה מכונת כביסה בבית, לא היה מיקרוגל לחמם אוכל מהיר, לא היה אוכל מוכן. היו שוחטים עוף, היו צריכים להכשיר אותו, לנקות אותו, למרוט את הנוצות.`;

    // מחלקים לפסקאות לפי שורות ריקות
    const paragraphs = userText
      .replace(/\r\n/g, '\n')
      .replace(/\n{3,}/g, '\n\n')
      .trim()
      .split(/\n\s*\n/)
      .filter(p => p.length > 0);

    const zip = new JSZip();
    const buffer = fs.readFileSync(templatePath);
    await zip.loadAsync(buffer);
    let documentXml = await zip.file('word/document.xml').async('string');

    console.log('🗑️ מוחק את כל התוכן הישן...');

    // נמצא את ההתחלה והסוף של הגוף
    const bodyStart = documentXml.indexOf('<w:body>') + '<w:body>'.length;
    const bodyEnd = documentXml.indexOf('</w:body>');

    // ניצור תוכן חדש עם הפסקאות של המשתמש
    let newBodyContent = '';
    paragraphs.forEach(paragraph => {
      newBodyContent += `
    <w:p w:rsidR="007754CD" w:rsidRDefault="00E60846">
      <w:pPr>
        <w:jc w:val="right"/>
      </w:pPr>
      <w:r>
        <w:t>${escapeXml(paragraph)}</w:t>
      </w:r>
    </w:p>`;
    });

    // נרכיב את המסמך מחדש
    const newDocumentXml = documentXml.substring(0, bodyStart) +
                          newBodyContent +
                          documentXml.substring(bodyEnd);

    zip.file('word/document.xml', newDocumentXml);
    const outBuffer = await zip.generateAsync({ type: 'nodebuffer' });
    fs.writeFileSync(outPath, outBuffer);

    console.log('✅ יצרתי קובץ עם הטקסט המדויק של המשתמש:', outPath);
    console.log('📊 מספר פסקאות:', paragraphs.length);

  } catch (error) {
    console.error('❌ שגיאה:', error);
  }
}

createWithUserText();