const fs = require('fs');
const path = require('path');
const JSZip = require('jszip');

function escapeXml(text) {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

async function createWithUserText() {
  try {
    const templatePath = path.join(__dirname, '×—×–×¨ ××”×©×¨×ª ×ª×§×™×Ÿ 2.docx');
    const outPath = path.join(__dirname, 'test-user-exact-text.docx');

    // ×”×˜×§×¡×˜ ×”××“×•×™×§ ×©×”××©×ª××© ×”×“×‘×™×§
    const userText = `×‘×¨×•×š ×”×©×, ×™×© ×œ× ×• ×©××—×” ×’×“×•×œ×” ×œ××œ××•×ª ××§×•××• ×©×œ ××“× ×’×“×•×œ, ×‘× ×¢×œ×™×™× ×××•×“ ×’×“×•×œ×•×ª, ×©×œ ×¨×‘ ×“×•×¨ ×¨×•×–× ×‘×œ×•× ×©×œ×™×˜"×, ×œ×‘×•× ×œ×“×‘×¨ ×‘×™×•× ×©×™×©×™ ×œ×›×‘×•×“ ×©×‘×ª ×§×•×“×©. ×›×›×” ×œ×—×‘×¨ ××ª ×™××•×ª ×”×—×•×œ ×¢× ×™××•×ª ×”×©×‘×ª ×‘×“×‘×¨×™× × ×¤×œ××™×. ×‘×¢×–×¨×ª ×”×©× ×™×ª×‘×¨×š, ×× ×—× ×• ××ª×—×™×œ×™× ×”×©×‘×•×¢ ×¤×¨×©×ª ×¢×§×‘. ×”×ª×•×¨×” ×›×•×ª×‘×ª ×‘×¤×¨×©×ª ×”×©×‘×•×¢: "×•×”×™×” ×¢×§×‘ ×ª×©××¢×•×Ÿ ××ª ×”××©×¤×˜×™× ×”××œ×” ×•×©××¨×ª× ×•×¢×©×™×ª× ××•×ª×". ××•××¨×™× ×—×–"×œ, ××” ×–×” "×•×”×™×” ×¢×§×‘ ×ª×©××¢×•×Ÿ"?

××‘×™× ×¨×©"×™: "××œ×• ×”××¦×•×•×ª ×©××“× ×“×© ×‘×¢×§×‘×™×•". ××™×“ × ×¦×˜×¨×š ×œ×”×‘×™×Ÿ, ××” ×¤×™×¨×•×© ×”××™×œ×” ×“×©? ××œ×” ×”××¦×•×•×ª ×”×§×œ×•×ª. ×œ××” ×”×ª×•×¨×” ×›×•×ª×‘×ª "×”××¦×•×•×ª ×©××“× ×“×©"? ××” ××”... ××– × ×ª×—×™×œ ××•×œ×™ ×‘×–×”. ×›×©××“× ×“×©, ××” ×–×” ××œ××›×ª ×“×© ×‘×©×‘×ª? ×™×© ×œ××“× ×—×™×˜×™×, ×©×™×‘×•×œ×™×. ×™×© ×©××” ××•×¥, ××ª ×”×©×™×‘×•×œ×™× ×•×™×© ××ª ×”×’×¨×’×¨×™× ×‘×¤× ×™×. ××™×š ××¤×¨×™×“×™×? ×œ×•×§×—×™× ×¤×¨×”, ×©××™× ×§×¨×©, ×•×”×¤×¨×” ×”×•×œ×›×ª ×¢× ×”×§×¨×©, ×•×”×§×¨×© ×¢×•×‘×¨ ×•××•×—×¥ ××ª ×”×—×™×˜×™×. ××¤×¨×™×“ ×‘×™×Ÿ ×”××•×¥ ×œ×‘×™×Ÿ ×”×’×¨×’×¨×™×. ×›×©××“× ××¡×ª×›×œ ×•×”×•× ×¨×•××” ×¤×”, ××” ×”×•× ×¨×•××”? ×”×•× ×¨×•××” ×ª×¢×¨×•×‘×ª ×©×œ ×©×™×‘×•×œ×™×, ×¨×•××” ××•×¥ ×‘×™×—×“ ×¢× ×’×¨×’×¨×™×. × ×¨××” ×©×œ× ×¢×©×™× ×• ×›×œ×•×. × ×¨××” ×©××™×Ÿ ×¤×” ×›×œ×•×, ×©×•× ×“×‘×¨ ×œ× ×”×©×ª× ×”. ×× ×™ ×¨×•××”, ×”×™×” ×©×™×‘×•×œ×™×, × ×©××¨ ×©×™×‘×•×œ×™×. ××‘×œ ××ª×™ ××ª×” ×¨×•××” ××ª ×”×©×™× ×•×™? ××’×™×¢×” ×”×¨×•×—, ××• ××ª×” ×–×•×¨×§ ××ª ×–×” ×‘×¨×•×—, ×”××•×¥ ×©×”×•× ×§×œ, ×¢×£. ×”×’×¨×’×¨×™× ×©×”× ×›×‘×“×™×, × ×©××¨×™×. ×•××– ××ª×” ×¨×•××” ×©××” ×©×¢×©×™×ª ×•×—×©×‘×ª ×©×œ× ×¢×©×™×ª ×›×œ×•×, ×—×©×‘×ª ×©××” ×©×”×™×” ×–×” ××” ×©× ×©××¨, ×–×” ×˜×¢×•×ª, ×¤×©×•×˜ ××•×¤×˜×™×ª, ×˜×¢×™×ª. ×™×© ×¤×” ×©×™× ×•×™ ×“×¨×¡×˜×™. ×¨×•×— ××—×ª ×”×¦××™×—×” ×œ×š ×›××Ÿ ×’×•×¨×Ÿ ×©×œ× ×©×œ ×“×’×Ÿ. × ×ª× ×” ×œ×š ×—×™×™×, ×—×™×•×ª, ×œ×—×, ×©×‘×• × ×•×ª× ×™× ×œ× ×• ××ª ×”×—×™×•×ª ×œ××“×. ××•××¨, ×™×©× × ×”×¨×‘×” ××¦×•×•×ª, ×›×•×ª×‘ ×¨×©"×™, ×›×©××“× ×¢×•×©×” ××•×ª×, ×”×•× ×¢×•×©×” ××ª ×”××¦×•×•×” ×•×”×•× ××•××¨, "×¤×©×©, ×× ×™ ×œ× ××¨×•×¦×” ××”××¦×•×•×” ×”×–××ª, × ×¨××” ×œ×™ ×©×œ× ×”×¦×œ×—×ª×™".

×”×•× ×¢×•×©×” ××™×–×” ××¦×•×•×” ×•×”×•× ××¨×’×™×© ×›×‘×™×›×•×œ ×©×”×•× ×œ× ×”×¦×œ×™×— ×œ×”×ª×¨×•×× ×¢×œ ×™×“×™ ××•×ª×” ××¦×•×•×”. ××‘×œ ×›×©××’×™×¢ ×¤×ª××•× ××™×–×” ×¨×•×—, ××’×™×¢ ×™××™× × ×•×¨××™×, ×”×•× ×©×•××¢ ××™×–×” ×©×™×—×” ××¢×•×¨×¨×ª, ××™×–×” ×¨×•×××•×ª ×××™×ª×™×ª, ××ª×” ×¨×•××” ××ª ×›×œ ×”××•×¥ ×¢×£.

×•××– ××ª×” ×¨×•××” ××ª ×”××™×œ×™× ×”×˜×•×‘×•×ª, ××ª ×”××¦×•×•×” ×©×”×•× ×¢×©×”, ××ª ×”××™×œ×” ×”×–××ª ×©×”×•× ×©××¢, ××” ×”×™× ×¢×•×©×” ×œ×•, ××™×š ×”×™× ××¨×•×××ª ××•×ª×•, ×œ××Ÿ ×”×™× ××¢×œ×” ××•×ª×•, ×œ××™×–×” ×¤×¡×’×•×ª ×”×™× ××‘×™××” ××•×ª×•.

××•××¨ ×¨×©"×™: "×•×”×™×” ×¢×§×‘ ×ª×©××¢×•×Ÿ". ×× ××ª×” ×¢×•×©×” ××¦×•×•×”, ×ª×¢×©×” ××ª ×”××¦×•×•×” ×¢× ×—×©×§. ×ª×¢×©×” ××ª ×”××¦×•×•×” ×¢× ×©××—×”. "×•×”×™×”", ×ª××™×“ ×•×”×™×” ××•××¨ ×”××•×¨ ×”×—×™×™× ×”×§×“×•×©, ×–×” ×œ×©×•×Ÿ ×©××—×”".×©×›×¨ ××¦×•×•×” ×‘×”××™ ×¢×œ×× ×œ×™×›×". ××™×Ÿ ×©×›×¨ ×¢×œ ×”××¦×•×•×ª ×‘×¢×•×œ× ×”×–×”. ×›×š ××•××¨×ª ×”×’××¨× ×‘×§×™×“×•×©×™×Ÿ ×‘×“×£ ×œ×˜ ×¢××•×“ ×‘'. ××™×Ÿ ×©×›×¨ ×¢×œ ×”××¦×•×•×ª ×‘×¢×•×œ× ×”×–×”. ××‘×œ ×›×•×ª×‘ ×”×—×™×“"×, ×©×× ××“× ××•×¡×™×£ ×ª×•×¡×¤×ª ××¢×¦××•, ×“×”×™×™× ×• ×”×•× ×˜×•×¨×—, ×¢×•×©×” ××™×–×” ×ª×•×¡×¤×ª ××¢×¦××•, ×–×” ×œ× ×—×™×•×‘ ××•×ª×š.

×–×” ×”×•× ××§×‘×œ ×©×›×¨ ×’× ×‘×¢×•×œ× ×”×–×”. ×•×”×•× ××•××¨, ×œ×›×Ÿ ×›×ª×•×‘ "×™×—×™×™× ×• ××™×•××™×™×". ××‘×¨×”× ××‘×™× ×• ×”×œ×š ×œ×¢×§×•×“ ××ª ×”×‘×Ÿ ×©×œ×• ×™×¦×—×§.

×¢×œ ×¢×§×™×“×ª ×™×¦×—×§ ×”×•× ×œ× ×§×™×‘×œ ×©×›×¨, ×–×” ×©×™×™×š ×œ×¢×•×œ× ×”×‘×. ××‘×œ ×¢×œ ×”×™×•××™×™× ×©×œ ×”×“×¨×š, ×©×”×•× ×”×•×œ×š ×‘×œ×™ ×œ×¢×¨×¢×¨ ×•×‘×œ×™ ×œ×˜×¢×•×ª ×•×œ×”×ª×—×¨×˜ ×¨×’×¢ ××—×“, "××” ×× ×™ ×”×•×œ×š ×œ×¢×©×•×ª? ×× ×™ ×”×•×œ×š ×œ×¢×§×•×“ ××ª ×”×‘×Ÿ ×©×œ×™, ××™×–×” ×—×™×œ×•×œ ×”×©× ×™×”×™×” ×¤×”, ××™×–×” ×—×•×¨×‘×Ÿ, ××” ×™×’×™×“×• ×›×œ ×”×¢×•×œ×?" ×”×•× ×œ× ×¢×¨×¢×¨, ×”×•× ×”×œ×š ×‘×©××—×”.

×¢×œ ××•×ª×” ×©××—×” ×©×”×•× ×”×œ×š, "×™×—×™×™× ×•". ×›×œ ×—×™×™ ×”×¢×•×œ× ×”×–×” ×× ×—× ×• ××•×›×œ×™× ××ª ×”×‘×¨×›×” ××”×™×•××™×™× ×”××œ×”. ××•××¨ ×”×©× ××©××•××œ, ×©×–×” ××” ×©×”×ª×•×¨×” ×›×•×ª×‘×ª.

×× ×ª×¢×©×” ××ª ×”××¦×•×•×ª, ×’× ×× ××ª×” ×œ× ××¨×•×¦×”, ××‘×œ ×ª×©××—, "×¢×©×™×ª×™ ××¦×•×•×”, ×”×ª×¨×•×××ª×™". ×¢×œ ×”×©××—×”, ×¢×œ "×•×”×™×”", ××ª×” ××§×‘×œ ×©×›×¨ ×‘×¢×•×œ× ×”×–×”.

××¤×™×œ×• ×©×©×›×¨ ××¦×•×•×” ×‘×”××™ ×¢×œ×× ×œ×™×›×. ××ª ×”×©×›×¨ ×¢×œ ×”××¦×•×•×”, ×¢×œ ×”×©××—×” ×©×œ ×”××¦×•×•×”, ××§×‘×œ ×‘×¢×•×œ× ×”×–×”. ×™×“×•×¢ ×©×›×ª×•×‘ ×‘×¡×¤×¨×™ ×—×¡×™×“×•×ª, ×©×›×©××“×...

×™×© ×”×¨×‘×” ×× ×©×™×, ××ª×” ×©×•××œ ××•×ª×•, "××”?" "××™×Ÿ ×œ×• ××¦×‘ ×¨×•×—". ××™×©×”×• ×¤×¢× ×—×©×‘, ×‘×“×•×¨×•×ª ×”×§×•×“××™×, ×”×™×” ×œ×”× ×‘×§×•×©×™ ×¤×¨× ×¡×”.

×œ× ×”×™×™×ª×” ××›×•× ×ª ×›×‘×™×¡×” ×‘×‘×™×ª, ×œ× ×”×™×” ××™×§×¨×•×’×œ ×œ×—×× ××•×›×œ ××”×™×¨, ×œ× ×”×™×” ××•×›×œ ××•×›×Ÿ. ×”×™×• ×©×•×—×˜×™× ×¢×•×£, ×”×™×• ×¦×¨×™×›×™× ×œ×”×›×©×™×¨ ××•×ª×•, ×œ× ×§×•×ª ××•×ª×•, ×œ××¨×•×˜ ××ª ×”× ×•×¦×•×ª.`;

    // ××—×œ×§×™× ×œ×¤×¡×§××•×ª ×œ×¤×™ ×©×•×¨×•×ª ×¨×™×§×•×ª
    const paragraphs = userText
      .replace(/\r\n/g, '\n')
      .replace(/\n{3,}/g, '\n\n')
      .trim()
      .split(/\n\s*\n/)
      .filter(p => p.length > 0);

    const zip = new JSZip();
    const buffer = fs.readFileSync(templatePath);
    await zip.loadAsync(buffer);
    let documentXml = await zip.file('word/document.xml').async('string');

    console.log('ğŸ—‘ï¸ ××•×—×§ ××ª ×›×œ ×”×ª×•×›×Ÿ ×”×™×©×Ÿ...');

    // × ××¦× ××ª ×”×”×ª×—×œ×” ×•×”×¡×•×£ ×©×œ ×”×’×•×£
    const bodyStart = documentXml.indexOf('<w:body>') + '<w:body>'.length;
    const bodyEnd = documentXml.indexOf('</w:body>');

    // × ×™×¦×•×¨ ×ª×•×›×Ÿ ×—×“×© ×¢× ×”×¤×¡×§××•×ª ×©×œ ×”××©×ª××©
    let newBodyContent = '';
    paragraphs.forEach(paragraph => {
      newBodyContent += `
    <w:p w:rsidR="007754CD" w:rsidRDefault="00E60846">
      <w:pPr>
        <w:jc w:val="right"/>
      </w:pPr>
      <w:r>
        <w:t>${escapeXml(paragraph)}</w:t>
      </w:r>
    </w:p>`;
    });

    // × ×¨×›×™×‘ ××ª ×”××¡××š ××—×“×©
    const newDocumentXml = documentXml.substring(0, bodyStart) +
                          newBodyContent +
                          documentXml.substring(bodyEnd);

    zip.file('word/document.xml', newDocumentXml);
    const outBuffer = await zip.generateAsync({ type: 'nodebuffer' });
    fs.writeFileSync(outPath, outBuffer);

    console.log('âœ… ×™×¦×¨×ª×™ ×§×•×‘×¥ ×¢× ×”×˜×§×¡×˜ ×”××“×•×™×§ ×©×œ ×”××©×ª××©:', outPath);
    console.log('ğŸ“Š ××¡×¤×¨ ×¤×¡×§××•×ª:', paragraphs.length);

  } catch (error) {
    console.error('âŒ ×©×’×™××”:', error);
  }
}

createWithUserText();