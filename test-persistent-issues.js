// בדיקת הבעיות שממשיכות
function testPersistentIssues() {
  console.log('🧪 Testing persistent Hebrew issues...');

  const problemText = `רש" י  ה "אוהב ישראל"   "וכל מדוי מצרים... לא ישימם בך" ]יורד שורה הפסוק]  את הארץ."  אני לא יודעתראו`;

  console.log('לפני תיקון:');
  console.log(problemText);

  // העתק הקוד המחוזק מהשרת
  let text = problemText
    // תיקון קיצורים עבריים נפוצים עם רווחים תקינים
    .replace(/רש\s*["\u0022\u201C\u201D]\s*י/g, 'רש"י')
    .replace(/חז\s*["\u0022\u201C\u201D]\s*ל/g, 'חז"ל')

    // תיקון קיצורים שנפרדו כבר בתמלול - גרסה מורחבת וחזקה יותר
    .replace(/חז\s*"\s*ל/g, 'חז"ל')
    .replace(/רש\s*"\s*י/g, 'רש"י')           // מחזק - גם עם רווח גם בלי
    .replace(/שליט\s*"\s*א/g, 'שליט"א')

    // תיקון קיצורים שעדיין עם רווחים
    .replace(/([א-ת]+)\s+"\s*([א-ת])/g, '$1"$2')    // כל מילה עברית " אות -> מילה"אות

    // תיקון גרשיים וציטוטים מתקדם - פתרון חזק וסופי
    // שלב 1: נקה סוגי גרשיים שונים לאחיד
    .replace(/["\u0022\u201C\u201D]/g, '"')

    // שלב 2: תקן גרשיים כפולים סביב שמות (ה "אוהב ישראל" -> ה"אוהב ישראל")
    .replace(/ה\s+"([^"]+)"/g, 'ה"$1"')            // ה "שם" -> ה"שם"
    .replace(/([א-ת])\s+"([^"]+)"/g, '$1"$2"')     // מילה "שם" -> מילה"שם"

    // תיקון מקרים ספציפיים של מילים צמודות
    .replace(/יודעתראו/g, 'יודעת ראו')
    .replace(/אומרתאני/g, 'אומרת אני')
    .replace(/שאלתיאותו/g, 'שאלתי אותו')
    .replace(/אמרתיכן/g, 'אמרתי כן')

    // תיקון בעיות פיסוק בסוף ציטוטים
    .replace(/([א-ת]+)"\s*]/g, '$1."]')                       // סוגריים מרובעים אחרי ציטוט
    .replace(/([א-ת]+)"\s*\]/g, '$1"]')                       // ללא נקודה

    // תיקון פיסוק חזק יותר - הסרת רווחים לפני פיסוק
    .replace(/\s+([.,!?:;])/g, '$1')              // הסר כל רווח לפני פיסוק
    .replace(/([.,!?:;])\s+/g, '$1 ')             // רווח יחיד אחרי פיסוק

    // ניקוי רווחים מיותרים
    .replace(/\s{2,}/g, ' ')                      // רווחים כפולים לרווח יחיד
    .replace(/^\s+|\s+$/gm, '')                   // רווחים בתחילת/סוף שורות
    .trim();

  console.log('\nאחרי תיקון:');
  console.log(text);

  console.log('\n=== ציפיות ===');
  console.log('✅ רש"י (ללא רווח)');
  console.log('✅ ה"אוהב ישראל" (ללא רווח לפני השם)');
  console.log('✅ לא ישימם בך."] (פיסוק נכון עם סוגריים)');
  console.log('✅ יודעת ראו (מילים נפרדות)');
}

testPersistentIssues();