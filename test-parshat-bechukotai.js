const fs = require('fs');
const { Document, Packer, Paragraph, TextRun, AlignmentType } = require('docx');

// פונקציה שמייצרת פסקאות מתוקנות (מהקובץ server.js)
function processTranscriptionContent(transcription) {
  const paragraphs = [];

  let cleanedText = transcription
    .replace(/\r\n/g, '\n')
    .replace(/\n{3,}/g, '\n\n')
    .trim();

  const sections = cleanedText
    .split(/\n\s*\n/)
    .map(s => s.trim())
    .filter(Boolean);

  sections.forEach(section => {
    paragraphs.push(new Paragraph({
      children: [
        new TextRun({
          text: section,
          font: { name: "Arial" },
          size: 24,
          rightToLeft: true,
          languageComplexScript: "he-IL"
        })
      ],
      style: "HebrewParagraph"
    }));
  });

  return paragraphs;
}

// הטקסט שהמשתמש סיפק
const testText = `פרשת השבוע שנקראה בעזרת השם, בחוקותי, שנת תשע"ד.

הפרשה המסיימת את חומש תורת כהנים, והיינו רוצים לעמוד על נקודה אחת בפרשה, בפסוק הראשון בפרשה, ולחבר אותה לבעל ההילולה של יום ראשון, ל"ג בעומר, רבי שמעון בר יוחאי. נתחיל בביאור הפסוק:

אם בחוקותי תלכו ואת מצוותי תשמרו ועשיתם אותם. מבטיח הקדוש ברוך הוא הבטחות של הנהגה מיוחדת מאוד בהנהגת הטבע. ונתתי גשמיכם בעתם, הגשם ירד רק בלילות שבת, אומר רש"י. ונתנה הארץ יבולה, ועץ השדה ייתן פריו. אפילו אילני סרק עתידים לעשות פירות. והקדוש ברוך הוא מבטיח ואכלתם לחמכם לשובע, אוכל מעט ומתברך במעיו. ונתתי שלום בארץ, מביא רש"י את דברי חז"ל על עניין השלום, וחרב לא תעבור בארצכם, אפילו חרב של שלום. והתורה מבטיחה הבטחות מיוחדות מאוד, אבל כל זה בתנאי שתהיו עמלים בתורה.

הכול מותנה לא רק בשמירת המצוות, אלא בעיקר בעניין עמל התורה. הרמב"ן כותב שכאשר עם ישראל יגיע למדרגה הזאת של עמל התורה, יהיו ישראל בכנים שלמים במדרגתם, ולא יתנהג עמם הטבע כלל, לא בגופם ולא בארצם, לא בכללם ולא ביחיד מהם, כי יברך השם לחמם ומימם ויסיר מחלה מקרבם, עד שלא יצטרכו לרופא ולהשתמר בדרך מדרך הרפואות, כמו שנאמר, כי אני השם רופאך. עם ישראל יהיה מושגח על-ידי הקדוש ברוך הוא באופן ישיר, הוא יהיה בריא, הכול יהיה בתהליך המושלם ביותר שישנו בבריאה. הכול בתנאי, אם בחוקותי תלכו - שתהיו עמלים בתורה.

בראש ובראשונה, לפני שאני אכנס לעניין עמל התורה, צריך לבאר איפה כתוב במילים: "אם בחוקותי תלכו" - שתהיו עמלים בתורה. רש"י כבר כותב שאם כתוב "את מצוותי תשמרו", הרי קיום המצוות אמור. כבר כתוב לך קיום המצוות, כשהוא אומר "אם בחוקותי תלכו", למה הכוונה? שתהיו עמלים בתורה. אולי הכוונה שכתוב "אם בחוקותי תלכו", שנקיים את המצוות שהם חוקים, ו"את מצוותי תשמרו" - הכוונה לשמור את המצוות שאינם חוקים. מאיפה לקחה תורת הכהנים שהמילה "אם בחוקותי תלכו" מבטאת עמל התורה?

בתורת כהנים מופיע עוד חלק אחד מעבר למה שרש"י מביא. "אם בחוקותי תלכו", הוא מלמד שהמקום מתאווה שיהיו ישראל עמלים בתורה. הקדוש ברוך הוא מתחנן ויש לו תאווה שעם ישראל יהיו עמלים בתורה. וכן הוא אומר: "לו עמי שומע לי, ישראל בדרכי יהלכו". אז המילה "יהלכו" מבטאת את עמל התורה. מצאנו כאן מקור בתורת כהנים שהליכה מבטאת עמל.

מאיפה לקחו חז"ל שאם הכוונה שהקדוש ברוך הוא מתאווה, אם בחוקותי תלכו, שהקדוש ברוך הוא מתאווה שנהיה עמלים בתורה? כותב שם הראב"ד בביאורו לתורת כהנים, מדי קאמר "אם", כד דריש שהוא לשון בקשה. "אם", הכוונה לשון בקשה, כמו שנאמר: "אם נא מצאתי חן בעיניך". וכן הוא אומר: "לו עמי שומע לי, ישראל בדרכי יהלכו".

הגמרא במסכת עבודה זרה בדף ה' אומרת: "אם בחוקותי תלכו", אין "אם" אלא לשון תחנונים. הגמרא אומרת שאם כתוב "אם", הכוונה ללשון תחנונים. אומר רש"י שהקדוש ברוך הוא מתחנן לפניהם שישמרו את התורה. "לו עמי" - היינו, תחינה, כמו שנאמר: "הן לו יהי כדבריך".`;

async function createTestDocument() {
  try {
    const doc = new Document({
      styles: {
        paragraphStyles: [{
          id: "HebrewParagraph",
          name: "Hebrew Paragraph",
          basedOn: "Normal",
          next: "HebrewParagraph",
          run: {
            font: "Arial",
            size: 24,
            rightToLeft: true
          },
          paragraph: {
            alignment: AlignmentType.RIGHT,
            bidirectional: true,
            rightToLeft: true,
            spacing: { after: 240, line: 360 }
          }
        }]
      },
      sections: [{
        properties: {
          rtl: true,
          titlePage: false
        },
        children: processTranscriptionContent(testText)
      }]
    });

    const buffer = await Packer.toBuffer(doc);
    const outputPath = './parshat-bechukotai-rtl-fixed.docx';
    fs.writeFileSync(outputPath, buffer);

    console.log('✅ קובץ פרשת בחוקותי נוצר בהצלחה:', outputPath);
    console.log('📊 מספר פסקאות שנוצרו:', testText.split(/\n\s*\n/).filter(Boolean).length);
  } catch (error) {
    console.error('❌ שגיאה ביצירת קובץ הבדיקה:', error);
  }
}

createTestDocument();