<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª××œ×•×œ ×—×›× - ××¢×¨×›×ª × ×™×”×•×œ ×“×§×•×ª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            position: relative;
        }

        .nav-tab.active {
            color: #667eea;
            font-weight: 600;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #667eea;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .nav-tab.active::after {
            transform: scaleX(1);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        .auth-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .link-btn {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 1em;
        }
        
        /* Dashboard styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f7f7ff;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #e0e0e0;
            border-left: 5px solid #667eea;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .user-info {
            background: #fbfaff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #764ba2;
        }
        
        /* Upload Area styles */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        /* Selected file styles */
        .selected-file {
            background: #f7f7ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            animation: fadeIn 0.5s ease;
        }

        .file-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-file {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }
        .remove-file:hover {
            background: #e74c3c;
        }
        
        /* Progress and Status styles */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .status {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            font-size: 1.1em;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .status.success { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
        .status.error { background: rgba(244, 67, 54, 0.1); color: #f44336; }
        .status.processing { background: rgba(255, 152, 0, 0.1); color: #ff9800; }

        .spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            margin: 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th, .history-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
        }

        .status-completed { background: #d4edda; color: #155724; }
        .status-processing { background: #fff3cd; color: #856404; }
        .status-failed { background: #f8d7da; color: #721c24; }

        .payment-option {
            background: rgba(102, 126, 234, 0.05);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
        }

        .payment-option:hover, .payment-option.selected {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.08);
            background: rgba(102, 126, 234, 0.1);
        }

        .admin-panel {
            background: rgba(255, 193, 7, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border-left: 5px solid #ffc107;
        }

        .insufficient-minutes {
            background: rgba(244, 67, 54, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
            color: #d32f2f;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ×ª××œ×•×œ ×—×›×</h1>
            <p>××¢×¨×›×ª ×ª××œ×•×œ ××ª×§×“××ª ×¢× × ×™×”×•×œ ×“×§×•×ª ××™×©×™</p>
            <div style="background: rgba(102, 126, 234, 0.1); padding: 10px; border-radius: 10px; margin-top: 15px; font-size: 0.9em; color: #667eea;">
                <strong>ğŸ¤– Powered by Gemini Pro</strong> | ğŸ“„ ×ª××œ×•×œ ××“×•×™×§ ×œ×§×•×‘×¥ Word ××¢×•×¦×‘
            </div>
        </div>

        <div id="authSection">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab(event, 'login')">×”×ª×—×‘×¨×•×ª</button>
                <button class="nav-tab" onclick="switchTab(event, 'register')">×”×¨×©××”</button>
            </div>

            <div id="loginTab" class="tab-content active">
                <div class="auth-container">
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="loginEmail">××™××™×™×œ:</label>
                            <input type="email" id="loginEmail" value="admin@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">×¡×™×¡××”:</label>
                            <input type="password" id="loginPassword" value="admin123" required>
                        </div>
                        <button type="submit" class="btn">×”×ª×—×‘×¨</button>
                    </form>
                    <div style="margin-top: 20px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 5px; font-size: 0.9em;">
                        <strong>ğŸ’¡ ×œ×‘×“×™×§×” ××”×™×¨×”:</strong><br>
                        ×× ×”×œ: admin@example.com / admin123<br>
                        ××©×ª××©: test@example.com / test123
                    </div>
                </div>
            </div>

            <div id="registerTab" class="tab-content">
                <div class="auth-container">
                    <form id="registerForm">
                        <div class="form-group"><label for="registerName">×©× ××œ×:</label><input type="text" id="registerName" required></div>
                        <div class="form-group"><label for="registerEmail">××™××™×™×œ:</label><input type="email" id="registerEmail" required></div>
                        <div class="form-group"><label for="registerPassword">×¡×™×¡××”:</label><input type="password" id="registerPassword" required minlength="6"></div>
                        <div class="form-group"><label for="registerPhone">×˜×œ×¤×•×Ÿ:</label><input type="tel" id="registerPhone"></div>
                        <button type="submit" class="btn">×”×™×¨×©×</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="appSection" style="display: none;">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchAppTab(event, 'dashboard')">×“×©×‘×•×¨×“</button>
                <button class="nav-tab" onclick="switchAppTab(event, 'transcribe')">×ª××œ×•×œ ×—×“×©</button>
                <button class="nav-tab" onclick="switchAppTab(event, 'history')">×”×™×¡×˜×•×¨×™×”</button>
                <button class="nav-tab" onclick="switchAppTab(event, 'payment')">×¨×›×™×©×ª ×“×§×•×ª</button>
                <button class="nav-tab" onclick="logout()">×™×¦×™××”</button>
            </div>

            <div id="dashboardTab" class="tab-content active">
                <div class="user-info">
                    <div id="userName" style="font-size: 1.3em; font-weight: 600;">×©× ×”××©×ª××©</div>
                    <div id="userEmail" style="color: #666;">user@example.com</div>
                </div>
                <div class="dashboard-grid">
                    <div class="stat-card"><div class="stat-number" id="remainingMinutes">0</div><div class="stat-label">×“×§×•×ª ×–××™× ×•×ª</div></div>
                    <div class="stat-card"><div class="stat-number" id="totalTranscribed">0</div><div class="stat-label">×“×§×•×ª ××•××œ×œ×•×ª</div></div>
                </div>
                <div id="adminPanel" class="admin-panel" style="display: none;">
                    <div style="font-size: 1.2em; font-weight: 600; margin-bottom: 15px;">ğŸ”§ ×¤×× ×œ × ×™×”×•×œ - ×”×•×¡×¤×ª ×“×§×•×ª</div>
                    <div class="form-group"><label for="adminUserEmail">××™××™×™×œ ×œ×§×•×—:</label><input type="email" id="adminUserEmail"></div>
                    <div class="form-group"><label for="adminMinutesToAdd">×“×§×•×ª ×œ×”×•×¡×¤×”:</label><input type="number" id="adminMinutesToAdd" min="1"></div>
                    <button class="btn" onclick="addMinutesToUser()">×”×•×¡×£ ×“×§×•×ª</button>
                </div>
            </div>

            <div id="transcribeTab" class="tab-content">
                <form id="transcriptionForm">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">×œ×—×¥ ×›××Ÿ ××• ×’×¨×•×¨ ×§×‘×¦×™×</div>
                        <div class="upload-subtext">×ª×•××š ×‘: MP3, MP4, WAV, M4A, MOV</div>
                        <input type="file" id="fileInput" class="file-input" accept="audio/*,video/*" multiple>
                    </div>
                    <div id="selectedFiles"></div>
                    <div id="estimatedCost" style="display: none;"></div>
                    <div class="form-group"><label for="language">×©×¤×ª ×”×ª××œ×•×œ:</label><select id="language"><option value="he">×¢×‘×¨×™×ª</option><option value="en">×× ×’×œ×™×ª</option></select></div>
                    <button type="submit" class="btn" id="submitBtn" disabled>ğŸš€ ×”×ª×—×œ ×ª××œ×•×œ</button>
                    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
                    <div class="status" id="status"></div>
                </form>
            </div>

            <div id="historyTab" class="tab-content">
                <h3>×”×™×¡×˜×•×¨×™×™×ª ×ª××œ×•×œ×™×</h3>
                <table class="history-table">
                    <thead><tr><th>×ª××¨×™×š</th><th>×©× ×§×•×‘×¥</th><th>××©×š</th><th>×©×¤×”</th><th>×¡×˜×˜×•×¡</th></tr></thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>

            <div id="paymentTab" class="tab-content">
                </div>
        </div>
    </div>

<script>
const API_BASE = '/api';
let currentUser = null;
let selectedFiles = [];

// =========================================================
//  UI Switching Logic
// =========================================================
function switchTab(event, tabName) {
    document.querySelectorAll('#authSection .nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('#authSection .tab-content').forEach(content => content.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById(tabName + 'Tab').classList.add('active');
}

function switchAppTab(event, tabName) {
    document.querySelectorAll('#appSection .nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('#appSection .tab-content').forEach(content => content.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById(tabName + 'Tab').classList.add('active');
    if (tabName === 'history') loadHistory();
}

// =========================================================
//  Authentication
// =========================================================
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
        const response = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        if (data.success) {
            currentUser = data.user;
            showApp();
        } else {
            alert(data.error || '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª');
        }
    } catch (error) {
        alert(`×©×’×™××ª ×¨×©×ª: ${error.message}`);
    }
});

document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const phone = document.getElementById('registerPhone').value;
    try {
        const response = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password, phone })
        });
        const data = await response.json();
        if (data.success) {
            currentUser = data.user;
            showApp();
            alert('×”×”×¨×©××” ×”×¦×œ×™×—×”! ×§×™×‘×œ×ª 30 ×“×§×•×ª ×ª××œ×•×œ ×‘××ª× ×”.');
        } else {
            alert(data.error || '×©×’×™××” ×‘×”×¨×©××”');
        }
    } catch (error) {
        alert(`×©×’×™××ª ×¨×©×ª: ${error.message}`);
    }
});

function showApp() {
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('appSection').style.display = 'block';
    updateDashboard();
}

function logout() {
    currentUser = null;
    document.getElementById('authSection').style.display = 'block';
    document.getElementById('appSection').style.display = 'none';
}

function updateDashboard() {
    if (!currentUser) return;
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('remainingMinutes').textContent = currentUser.remainingMinutes;
    document.getElementById('totalTranscribed').textContent = currentUser.totalTranscribed;
    document.getElementById('adminPanel').style.display = currentUser.isAdmin ? 'block' : 'none';
}

async function addMinutesToUser() {
    const email = document.getElementById('adminUserEmail').value.trim();
    const minutes = parseInt(document.getElementById('adminMinutesToAdd').value);

    if (!currentUser?.isAdmin) return alert('××™×Ÿ ×”×¨×©××•×ª ×× ×”×œ');
    if (!email || !minutes || minutes <= 0) return alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×›×¨××•×™');

    try {
        const response = await fetch('/api/admin/add-minutes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userEmail: email, minutes: minutes })
        });
        const data = await response.json();
        if (data.success) {
            alert(`âœ… × ×•×¡×¤×• ${minutes} ×“×§×•×ª ×œ××©×ª××© ${email}`);
            document.getElementById('adminUserEmail').value = '';
            document.getElementById('adminMinutesToAdd').value = '';
            if (currentUser.email === email) {
                currentUser.remainingMinutes = data.newBalance;
                updateDashboard();
            }
        } else {
            alert(`âŒ ${data.error}`);
        }
    } catch (error) {
        alert(`âŒ ×©×’×™××ª ×¨×©×ª: ${error.message}`);
    }
}

// =========================================================
//  File Handling & UI
// =========================================================
function getAudioDuration(file) {
    return new Promise((resolve) => {
        const audio = document.createElement('audio');
        audio.src = URL.createObjectURL(file);
        audio.onloadedmetadata = () => {
            resolve(Math.ceil(audio.duration / 60));
            URL.revokeObjectURL(audio.src);
        };
        audio.onerror = () => {
            // Fallback for files that are not audio/video or have issues
            resolve(Math.max(1, Math.ceil(file.size / (1024 * 1024 * 2))));
            URL.revokeObjectURL(audio.src);
        };
    });
}

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const selectedFilesDiv = document.getElementById('selectedFiles');

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

async function handleFiles(files) {
    showStatus('××—×©×‘ ××©×š ×–××Ÿ...', 'processing');
    for (const file of files) {
        const duration = await getAudioDuration(file);
        selectedFiles.push({ file, duration });
        displayFile(file, duration);
    }
    updateCostEstimate();
    updateSubmitButton();
    hideStatus();
}

function displayFile(file, duration) {
    const fileDiv = document.createElement('div');
    fileDiv.className = 'selected-file';
    fileDiv.setAttribute('data-filename', file.name);
    fileDiv.innerHTML = `
        <div class="file-info">
            <div>
                <div style="font-weight: 600;">${file.name}</div>
                <div style="font-size: 0.9em; color: #666;">â±ï¸ ××©×š ×–××Ÿ: ×›-${duration} ×“×§×•×ª</div>
            </div>
            <button type="button" class="remove-file" onclick="removeFile('${file.name}')">Ã—</button>
        </div>`;
    selectedFilesDiv.appendChild(fileDiv);
}

function removeFile(fileName) {
    selectedFiles = selectedFiles.filter(item => item.file.name !== fileName);
    const fileDiv = document.querySelector(`[data-filename="${fileName}"]`);
    if (fileDiv) fileDiv.remove();
    updateCostEstimate();
    updateSubmitButton();
}

function updateSubmitButton() {
    document.getElementById('submitBtn').disabled = selectedFiles.length === 0;
}

function updateCostEstimate() {
    const costDiv = document.getElementById('estimatedCost');
    if (selectedFiles.length === 0) {
        costDiv.style.display = 'none';
        return;
    }
    const totalMinutes = selectedFiles.reduce((sum, item) => sum + item.duration, 0);
    const remaining = currentUser.remainingMinutes;
    costDiv.style.display = 'block';

    if (totalMinutes > remaining) {
        costDiv.className = 'insufficient-minutes';
        costDiv.innerHTML = `<strong>×—×¡×¨×•×ª ${totalMinutes - remaining} ×“×§×•×ª!</strong> (× ×“×¨×©: ${totalMinutes}, ×™×ª×¨×”: ${remaining})`;
        document.getElementById('submitBtn').disabled = true;
    } else {
        costDiv.className = 'status success';
        costDiv.innerHTML = `<strong>×¢×œ×•×ª: ${totalMinutes} ×“×§×•×ª.</strong> ×™×ª×¨×” ×œ××—×¨ ×ª××œ×•×œ: ${remaining - totalMinutes} ×“×§×•×ª.`;
        document.getElementById('submitBtn').disabled = false;
    }
}

// =========================================================
//  FIX: Improved Status & Progress UI
// =========================================================
function showStatus(message, type) {
    const status = document.getElementById('status');
    const icons = {
        success: 'âœ…',
        error: 'âŒ',
        processing: '<div class="spinner"></div>'
    };
    
    status.className = `status ${type}`;
    status.innerHTML = `${icons[type] || ''} <div>${message}</div>`;
    status.style.display = 'flex';
}

function hideStatus() {
    const status = document.getElementById('status');
    // Hide only if it's a temporary processing message
    if (status.classList.contains('processing')) {
        setTimeout(() => { status.style.display = 'none'; }, 2000);
    }
}

function updateProgress(percent) {
    document.getElementById('progressBar').style.display = 'block';
    document.getElementById('progressFill').style.width = percent + '%';
}

// =========================================================
//  Transcription Submission
// =========================================================
document.getElementById('transcriptionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (selectedFiles.length === 0) return alert('×× × ×‘×—×¨ ×§×‘×¦×™× ×œ×ª××œ×•×œ');
    
    const totalMinutes = selectedFiles.reduce((sum, item) => sum + item.duration, 0);
    if (totalMinutes > currentUser.remainingMinutes) return alert('××™×Ÿ ××¡×¤×™×§ ×“×§×•×ª ×‘×—×©×‘×•×Ÿ');

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'â³ ××¢×‘×“...';
    
    showStatus('×”×§×‘×¦×™× × ×©×œ×—×™× ×œ×¢×™×‘×•×“... ×”×ª×•×¦××•×ª ×™×™×©×œ×—×• ×œ××™×™×œ.', 'processing');
    updateProgress(10); // Initial progress

    try {
        const formData = new FormData();
        selectedFiles.forEach(item => formData.append('files', item.file));
        formData.append('email', currentUser.email);
        formData.append('language', document.getElementById('language').value);
        
        // Simulate upload progress
        setTimeout(() => updateProgress(50), 500);

        const response = await fetch(`${API_BASE}/transcribe`, {
            method: 'POST',
            body: formData
        });

        updateProgress(100);
        const data = await response.json();

        if (data.success) {
            currentUser.remainingMinutes -= data.estimatedMinutes;
            currentUser.totalTranscribed += data.estimatedMinutes;
            updateDashboard();
            
            showStatus(`<strong>×”×ª××œ×•×œ ×”×ª×—×™×œ ×‘×”×¦×œ×—×”!</strong><br><small>×”×§×‘×¦×™× ×™×™×©×œ×—×• ×œ××™×™×œ <strong>${currentUser.email}</strong>. ×”×ª×”×œ×™×š ×¢×©×•×™ ×œ×§×—×ª ××¡×¤×¨ ×“×§×•×ª.</small>`, 'success');
            
            // Reset UI
            selectedFiles = [];
            selectedFilesDiv.innerHTML = '';
            updateCostEstimate();
            fileInput.value = '';
        } else {
            throw new Error(data.error || '××™×¨×¢×” ×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×‘×¦×™×');
        }

    } catch (error) {
        showStatus(`×©×’×™××”: ${error.message}`, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸš€ ×”×ª×—×œ ×ª××œ×•×œ';
        setTimeout(() => {
            document.getElementById('progressBar').style.display = 'none';
            updateProgress(0);
        }, 3000);
    }
});

// =========================================================
//  History
// =========================================================
function loadHistory() {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×”...</td></tr>';
    
    if (!currentUser || !currentUser.history || currentUser.history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×ª××œ×•×œ×™×</td></tr>';
        return;
    }
    
    tbody.innerHTML = ''; // Clear loading message
    [...currentUser.history].reverse().forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.date}</td>
            <td>${item.fileName}</td>
            <td>${item.duration} ×“×§×•×ª</td>
            <td>${item.language === 'he' ? '×¢×‘×¨×™×ª' : '×× ×’×œ×™×ª'}</td>
            <td><span class="status-badge status-${item.status}">${item.status === 'completed' ? '×”×•×©×œ×' : '× ×›×©×œ'}</span></td>
        `;
        tbody.appendChild(row);
    });
}
</script>

</body>
</html>
