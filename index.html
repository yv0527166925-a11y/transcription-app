<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תמלול חכם</title>
    <style>
        /* (Your CSS from before goes here) */
        /* NEW: Styles for history table */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .history-table th, .history-table td { padding: 12px; text-align: right; border-bottom: 1px solid #dddfe2; }
        .history-table th { background-color: #f0f2f5; font-weight: 600; }
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.8em; }
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-failed { background-color: #f8d7da; color: #721c24; }
        .download-btn { background-color: #1877f2; color: white; padding: 5px 10px; border-radius: 5px; text-decoration: none; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <div id="appSection" style="display: none;">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="transcribe">תמלול חדש</button>
                <button class="nav-tab" data-tab="dashboard">לוח בקרה</button>
                <button class="nav-tab" data-tab="history">היסטוריה</button>
                <button id="logoutBtn" class="nav-tab">יציאה</button>
            </div>
            
            <div id="historyTab" class="tab-content">
                <h3>היסטוריית תמלולים</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>שם קובץ</th>
                            <th>סטטוס</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        </tbody>
                </table>
            </div>

            <div id="status" class="status"></div>
        </div>
    </div>
<script>
    let currentUser = null;
    // (Other variables remain the same)

    // --- Event Listeners ---
    document.querySelectorAll('.nav-tabs').forEach(nav => nav.addEventListener('click', (e) => {
        if (e.target.matches('.nav-tab')) {
            const tabName = e.target.dataset.tab;
            switchTab(e.currentTarget, tabName);
            // NEW: Load history when tab is clicked
            if (tabName === 'history') {
                loadHistory();
            }
        }
    }));
    // (Other event listeners remain the same)

    // --- UI Functions ---
    // (switchTab, showStatus, updateDashboard, file handling functions remain the same)

    // =========================================================
    //  NEW: Function to load and display transcription history
    // =========================================================
    function loadHistory() {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = ''; // Clear previous content

        if (!currentUser || !currentUser.history || currentUser.history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">אין היסטוריית תמלולים.</td></tr>';
            return;
        }

        // Display history in reverse chronological order
        [...currentUser.history].reverse().forEach(item => {
            const row = document.createElement('tr');
            const date = new Date(item.date).toLocaleString('he-IL');
            const statusClass = item.status === 'completed' ? 'status-completed' : 'status-failed';
            const statusText = item.status === 'completed' ? 'הושלם' : 'נכשל';
            
            let actionsHtml = 'N/A';
            if (item.status === 'completed' && item.fileId) {
                // Construct the download link securely
                actionsHtml = `<a href="/api/download/${item.fileId}?userEmail=${currentUser.email}" class="download-btn" download>הורדה</a>`;
            }

            row.innerHTML = `
                <td>${date}</td>
                <td>${item.fileName}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${actionsHtml}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // --- API & Logic ---
    // (handleAuth, addMinutesToUser, handleTranscription, etc. remain the same)

</script>
</body>
</html>
