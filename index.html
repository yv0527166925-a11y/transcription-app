<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תמלול חכם</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); max-width: 700px; width: 100%; padding: 30px; }
        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { color: #1c1e21; font-size: 2.2em; margin-bottom: 5px; }
        .header p { color: #606770; font-size: 1.1em; }
        .nav-tabs { display: flex; border-bottom: 1px solid #dddfe2; margin-bottom: 25px; }
        .nav-tab { flex: 1; padding: 15px; text-align: center; background: none; border: none; font-size: 1.1em; cursor: pointer; color: #606770; position: relative; }
        .nav-tab.active { color: #1877f2; font-weight: 600; }
        .nav-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background-color: #1877f2; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; color: #606770; font-weight: 600; }
        input, select { width: 100%; padding: 12px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 1em; }
        input:focus { border-color: #1877f2; outline: none; box-shadow: 0 0 0 2px #e7f3ff; }
        .btn { width: 100%; padding: 12px; background: #1877f2; color: white; border: none; border-radius: 6px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .btn:hover:not(:disabled) { background: #166fe5; }
        .btn:disabled { background: #a0bdf1; cursor: not-allowed; }
        #appSection { display: none; }
        .user-info, .stat-card, .admin-panel { background: #f0f2f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-number { font-size: 2em; font-weight: 700; color: #1877f2; }
        .upload-area { border: 2px dashed #ccd0d5; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: background 0.2s; }
        .upload-area:hover, .upload-area.dragover { background: #f7f8fa; border-color: #1877f2; }
        .file-list-item { display: flex; justify-content: space-between; align-items: center; background: #f0f2f5; padding: 10px; border-radius: 6px; margin-bottom: 8px; }
        .status { text-align: center; padding: 12px; border-radius: 6px; margin-top: 15px; display: none; }
        .status.success { background: #e7f3ff; color: #1877f2; }
        .status.error { background: #ffebe8; color: #c92a10; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>תמלול חכם</h1>
            <p>העלה קובץ אודיו וקבל תמלול מדויק למייל</p>
        </div>

        <div id="authSection">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="login">התחברות</button>
                <button class="nav-tab" data-tab="register">הרשמה</button>
            </div>
            <div id="loginTab" class="tab-content active">
                <form id="loginForm">
                    <div class="form-group"><label for="loginEmail">אימייל:</label><input type="email" id="loginEmail" value="admin@example.com" required></div>
                    <div class="form-group"><label for="loginPassword">סיסמה:</label><input type="password" id="loginPassword" value="admin123" required></div>
                    <button type="submit" class="btn">התחבר</button>
                </form>
            </div>
            <div id="registerTab" class="tab-content">
                <form id="registerForm">
                    <div class="form-group"><label for="registerName">שם:</label><input type="text" id="registerName" required></div>
                    <div class="form-group"><label for="registerEmail">אימייל:</label><input type="email" id="registerEmail" required></div>
                    <div class="form-group"><label for="registerPassword">סיסמה:</label><input type="password" id="registerPassword" required></div>
                    <button type="submit" class="btn">הירשם</button>
                </form>
            </div>
        </div>

        <div id="appSection">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="transcribe">תמלול חדש</button>
                <button class="nav-tab" data-tab="dashboard">לוח בקרה</button>
                <button id="logoutBtn" class="nav-tab">יציאה</button>
            </div>
            <div id="transcribeTab" class="tab-content active">
                <form id="transcriptionForm">
                    <div class="upload-area" id="uploadArea">
                        <p>גרור לכאן קבצים או לחץ לבחירה</p>
                        <input type="file" id="fileInput" multiple hidden>
                    </div>
                    <div id="fileList" style="margin-top: 15px;"></div>
                    <button type="submit" class="btn" id="submitBtn" disabled>התחל תמלול</button>
                </form>
            </div>
            <div id="dashboardTab" class="tab-content">
                <div class="user-info">שלום, <strong id="userName"></strong>!</div>
                <div class="dashboard-grid">
                    <div class="stat-card"><div class="stat-number" id="remainingMinutes">0</div><div>דקות זמינות</div></div>
                    <div class="stat-card"><div class="stat-number" id="totalTranscribed">0</div><div>דקות שתמללו</div></div>
                </div>
                <div id="adminPanel" style="display: none;" class="admin-panel">
                    <h4>פאנל ניהול</h4>
                    <div class="form-group"><label for="adminUserEmail">אימייל לקוח:</label><input type="email" id="adminUserEmail"></div>
                    <div class="form-group"><label for="adminMinutesToAdd">דקות להוספה:</label><input type="number" id="adminMinutesToAdd"></div>
                    <button id="addMinutesBtn" class="btn">הוסף דקות</button>
                </div>
            </div>
            <div id="status" class="status"></div>
        </div>
    </div>

<script>
    const API_BASE = '/api';
    let currentUser = null;
    let filesToUpload = [];

    const authSection = document.getElementById('authSection');
    const appSection = document.getElementById('appSection');
    const statusDiv = document.getElementById('status');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileListDiv = document.getElementById('fileList');
    const submitBtn = document.getElementById('submitBtn');

    // --- Event Listeners ---
    document.querySelector('.nav-tabs').addEventListener('click', (e) => {
        if (e.target.matches('.nav-tab')) {
            const tabName = e.target.dataset.tab;
            switchTab(e.target.closest('.nav-tabs'), tabName);
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('loginForm').addEventListener('submit', handleAuth);
    document.getElementById('registerForm').addEventListener('submit', handleAuth);
    document.getElementById('transcriptionForm').addEventListener('submit', handleTranscription);

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    if (document.getElementById('addMinutesBtn')) {
        document.getElementById('addMinutesBtn').addEventListener('click', addMinutesToUser);
    }
    
    // --- UI Functions ---
    function switchTab(nav, tabName) {
        nav.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        nav.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        nav.parentElement.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `${tabName}Tab`);
        });
    }

    function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
        statusDiv.style.display = 'block';
    }

    function updateDashboard() {
        if (!currentUser) return;
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('remainingMinutes').textContent = currentUser.remainingMinutes;
        document.getElementById('totalTranscribed').textContent = currentUser.totalTranscribed;
        document.getElementById('adminPanel').style.display = currentUser.isAdmin ? 'block' : 'none';
    }

    // --- File Handling ---
    function handleFiles(files) {
        filesToUpload.push(...Array.from(files));
        renderFileList();
        submitBtn.disabled = filesToUpload.length === 0;
    }

    function renderFileList() {
        fileListDiv.innerHTML = '';
        filesToUpload.forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-list-item';
            fileDiv.innerHTML = `<span>${file.name}</span><button type="button" data-index="${index}" style="background:none;border:none;color:red;cursor:pointer;">&times;</button>`;
            fileListDiv.appendChild(fileDiv);
        });
    }

    fileListDiv.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const index = parseInt(e.target.dataset.index);
            filesToUpload.splice(index, 1);
            renderFileList();
            submitBtn.disabled = filesToUpload.length === 0;
        }
    });

    // --- API Calls ---
    async function handleAuth(e) {
        e.preventDefault();
        const endpoint = e.target.id === 'loginForm' ? 'login' : 'register';
        const body = Object.fromEntries(new FormData(e.target));
        
        try {
            const response = await fetch(`${API_BASE}/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            
            currentUser = data.user;
            authSection.style.display = 'none';
            appSection.style.display = 'block';
            updateDashboard();
        } catch (error) {
            showStatus(error.message, 'error');
        }
    }

    async function handleTranscription(e) {
        e.preventDefault();
        submitBtn.disabled = true;
        showStatus('מעלה קבצים ומעבד...', 'success');

        const formData = new FormData();
        filesToUpload.forEach(file => formData.append('files', file));
        formData.append('email', currentUser.email);

        try {
            const response = await fetch(`${API_BASE}/transcribe`, { method: 'POST', body: formData });
            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            currentUser.remainingMinutes -= data.estimatedMinutes;
            updateDashboard();
            showStatus('התמלול התחיל! התוצאות יישלחו למייל שלך בקרוב.', 'success');
            filesToUpload = [];
            renderFileList();
        } catch (error) {
            showStatus(error.message, 'error');
        } finally {
            submitBtn.disabled = filesToUpload.length > 0;
        }
    }

    async function addMinutesToUser() {
        const userEmail = document.getElementById('adminUserEmail').value;
        const minutes = document.getElementById('adminMinutesToAdd').value;
        try {
            const response = await fetch(`${API_BASE}/admin/add-minutes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userEmail, minutes })
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            showStatus(data.message, 'success');
            if (currentUser.email === userEmail) {
                currentUser.remainingMinutes = data.newBalance;
                updateDashboard();
            }
        } catch (error) {
            showStatus(error.message, 'error');
        }
    }

    function logout() {
        currentUser = null;
        authSection.style.display = 'block';
        appSection.style.display = 'none';
    }
</script>
</body>
</html>
