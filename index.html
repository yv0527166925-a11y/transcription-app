<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תמלול חכם - מערכת ניהול דקות</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #ffffff, #f8fafc);
            min-height: 100vh;
            padding: 20px;
            color: #6b7280;
        }

        /* Cookie Banner Styles */
        .cookie-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d3748;
            color: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            border-top: 3px solid #3b82f6;
        }

        .cookie-banner-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .cookie-banner-text {
            flex: 1;
            min-width: 300px;
        }

        .cookie-banner-text h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #fff;
        }

        .cookie-banner-text p {
            margin: 0;
            color: #e2e8f0;
            line-height: 1.5;
        }

        .cookie-banner-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .cookie-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .cookie-btn-accept {
            background: #3b82f6;
            color: white;
        }

        .cookie-btn-accept:hover {
            background: #2563eb;
        }

        .cookie-btn-decline {
            background: transparent;
            color: #e2e8f0;
            border: 2px solid #4a5568;
        }

        .cookie-btn-decline:hover {
            background: #4a5568;
            color: white;
        }

        @media (max-width: 768px) {
            .cookie-banner-content {
                flex-direction: column;
                text-align: center;
            }

            .cookie-banner-buttons {
                justify-content: center;
                width: 100%;
            }
        }

        .container {
            background: #ffffff;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-width: 95%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #1f2937;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .nav-tab.active {
            color: #3b82f6;
            border-bottom: 3px solid #3b82f6;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .auth-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-clear-all {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 4px rgba(255, 107, 107, 0.3);
            min-width: 60px;
        }

        .btn-clear-all:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
            background: linear-gradient(45deg, #ff5252, #e74c3c);
        }

        .btn-clear-all:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .btn-upload-option {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-width: 140px;
        }

        .btn-upload-option:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .btn-upload-option:active {
            transform: translateY(0);
        }

        .folder-preview {
            background: rgba(59, 130, 246, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #3b82f6;
            display: none;
        }

        .folder-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .folder-files {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .folder-file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .folder-file-item:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .folder-file-item:last-child {
            border-bottom: none;
        }

        .folder-file-checkbox {
            margin-left: 10px;
            margin-right: 10px;
        }

        .folder-file-info {
            flex: 1;
        }

        .folder-file-name {
            font-weight: 500;
            color: #333;
        }

        .folder-file-size {
            font-size: 0.85em;
            color: #666;
        }

        .folder-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }


        .text-center {
            text-align: center;
        }

        .link-btn {
            background: none;
            border: none;
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
            font-size: 1em;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(59, 130, 246, 0.1);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border-left: 4px solid #3b82f6;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .user-info {
            background: #ffffff;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .user-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .user-email {
            color: #6b7280;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f9fafb;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #3b82f6;
            background: #dbeafe;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #3b82f6;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #555;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #888;
            font-size: 0.9em;
        }

        .file-input {
            display: none;
        }

        .selected-file {
            background: rgba(59, 130, 246, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }

        .file-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            font-weight: 600;
            color: #333;
        }

        .file-size {
            color: #666;
            font-size: 0.9em;
        }

        .file-duration {
            color: #3b82f6;
            font-size: 0.9em;
            font-weight: 600;
        }

        .remove-file {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .status.processing {
            background: rgba(255, 152, 0, 0.1);
            color: #ff9800;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
        }

        .history-table th {
            background: rgba(59, 130, 246, 0.1);
            font-weight: 600;
            color: #333;
        }

        .history-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .payment-option {
            background: rgba(59, 130, 246, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .payment-option:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .payment-option.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }

        .payment-amount {
            font-size: 2em;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 5px;
        }

        .payment-minutes {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .payment-price {
            color: #333;
            font-size: 1.3em;
            font-weight: 600;
        }

        .admin-panel {
            background: rgba(255, 193, 7, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .admin-table th {
            background: #3b82f6;
            color: white;
            padding: 12px;
            text-align: right;
            font-weight: 600;
        }

        .admin-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: right;
        }

        .admin-table tbody tr:hover {
            background: #f8f9fa;
        }

        .admin-table .action-btn {
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin: 0 2px;
        }

        .admin-table .btn-edit {
            background: #17a2b8;
            color: white;
        }

        .admin-table .btn-delete {
            background: #dc3545;
            color: white;
        }

        .admin-table .btn-success {
            background: #28a745;
            color: white;
        }

        .admin-title {
            color: #333;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .insufficient-minutes {
            background: rgba(244, 67, 54, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
            color: #d32f2f;
        }

        .features {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
        }

        .features h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .features ul {
            list-style: none;
            color: #666;
        }

        .features li {
            padding: 8px 0;
            position: relative;
            padding-right: 25px;
        }

        .features li::before {
            content: '✓';
            position: absolute;
            right: 0;
            color: #4caf50;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .payment-options {
                grid-template-columns: 1fr;
            }
        }

        .debug-info {
            background: rgba(255, 255, 0, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.8em;
            color: #666;
            border-left: 3px solid #ffc107;
        }
    </style>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 תמלול חכם</h1>
            <p>מערכת תמלול מתקדמת עם ניהול דקות אישי</p>
            <div style="background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 10px; margin-top: 15px; font-size: 0.9em; color: #3b82f6;">
                <strong>🤖 Powered by Gemini 2.5 Pro</strong> | 📄 תמלול מדויק לקובץ Word מעוצב
            </div>
            
           <div style="background: #3b82f6; padding: 15px; border-radius: 10px; margin-top: 15px; text-align: center;">
    <p style="margin: 0; font-size: 16px; font-weight: bold; color: white;">
        📞 לתמיכה ורכישת דקות: timlul.h@gmail.com
    </p>
</div>

        <!-- Login/Register Section -->
        <div id="authSection">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('login')">התחברות</button>
                <button class="nav-tab" onclick="switchTab('register')">הרשמה</button>
            </div>

            <div id="loginTab" class="tab-content active">
                <div class="auth-container">
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="loginEmail">אימייל:</label>
                          <input type="text" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">סיסמה:</label>
                           <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn">התחבר</button>
                    </form>
                   <div class="text-center">
                        <button class="link-btn" onclick="switchTab('register')">אין לך חשבון? הירשם כאן</button>
                    </div>
                </div>
                <!-- Status for auth messages -->
                <div class="status" id="authStatus" style="display: none;"></div>
            </div>

            <div id="registerTab" class="tab-content">
                <div class="auth-container">
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="registerName">שם מלא:</label>
                            <input type="text" id="registerName" required>
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">אימייל:</label>
                           <input type="text" id="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">סיסמה:</label>
                            <input type="password" id="registerPassword" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="registerPhone">טלפון:</label>
                            <input type="tel" id="registerPhone">
                        </div>
                        <button type="submit" class="btn">הירשם</button>
                    </form>
                    <div class="text-center">
                        <button class="link-btn" onclick="switchTab('login')">יש לך חשבון? התחבר כאן</button>
                    </div>
                </div>
                <!-- Status for auth messages -->
                <div class="status" id="registerAuthStatus" style="display: none;"></div>
            </div>

            <!-- Email Verification Tab -->
            <div id="verificationTab" class="tab-content">
                <div class="auth-container">
                    <h3>אימות מייל</h3>
                    <p>נשלח קוד אימות לכתובת המייל שלך. אנא הזן את הקוד כדי להשלים את ההרשמה.</p>

                    <form id="verificationForm">
                        <div class="form-group">
                            <label for="verificationEmail">אימייל:</label>
                            <input type="email" id="verificationEmail" readonly>
                        </div>
                        <div class="form-group">
                            <label for="verificationCode">קוד אימות (6 ספרות):</label>
                            <input type="text" id="verificationCode" maxlength="6" pattern="[0-9]{6}" required
                                   placeholder="123456" style="text-align: center; font-size: 18px; letter-spacing: 3px;">
                        </div>
                        <button type="submit" class="btn">אמת מייל</button>
                    </form>

                    <div class="text-center" style="margin-top: 20px;">
                        <button class="link-btn" onclick="switchTab('register')">חזור להרשמה</button>
                        <button class="link-btn" onclick="switchTab('login')">יש לך חשבון? התחבר כאן</button>
                    </div>
                </div>
                <!-- Status for verification messages -->
                <div class="status" id="verificationAuthStatus" style="display: none;"></div>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="appSection" style="display: none;">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchAppTab('dashboard')">דשבורד</button>
                <button class="nav-tab" onclick="switchAppTab('transcribe')">תמלול חדש</button>
                <button class="nav-tab" onclick="switchAppTab('history')">היסטוריה</button>
                <button class="nav-tab" onclick="switchAppTab('payment')">רכישת דקות</button>
                <button class="nav-tab" onclick="logout()">יציאה</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="user-info">
                    <div class="user-name" id="userName">שם המשתמש</div>
                    <div class="user-email" id="userEmail">user@example.com</div>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="remainingMinutes">0</div>
                        <div class="stat-label">דקות זמינות</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTranscribed">0</div>
                        <div class="stat-label">דקות מתומללות</div>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="adminPanel" class="admin-panel" style="display: none;">
                    <!-- Admin Sub-tabs -->
                    <div class="nav-tabs">
                        <button class="nav-tab active" onclick="switchAdminTab('overview')">סקירה כללית</button>
                        <button class="nav-tab" onclick="switchAdminTab('users')">ניהול משתמשים</button>
                        <button class="nav-tab" onclick="switchAdminTab('transcriptions')">תמלולים</button>
                        <button class="nav-tab" onclick="switchAdminTab('add-minutes')">הוספת דקות</button>
                    </div>

                    <!-- Overview Tab -->
                    <div id="overviewTab" class="tab-content active">
                        <div class="admin-title">📊 סקירה כללית</div>
                        <div class="admin-stats">
                            <div class="stat-card">
                                <div class="stat-number" id="totalUsers">-</div>
                                <div class="stat-label">סה"כ משתמשים</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="newUsersToday">-</div>
                                <div class="stat-label">משתמשים חדשים היום</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalTranscriptions">-</div>
                                <div class="stat-label">סה"כ תמלולים</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalMinutesUsed">-</div>
                                <div class="stat-label">דקות שנוצלו</div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Management Tab -->
                    <div id="usersTab" class="tab-content">
                        <div class="admin-title">👥 ניהול משתמשים</div>
                        <div class="table-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>שם</th>
                                        <th>אימייל</th>
                                        <th>דקות זמינות</th>
                                        <th>דקות מתומללות</th>
                                        <th>תאריך הצטרפות</th>
                                        <th>פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Transcriptions Tab -->
                    <div id="transcriptionsTab" class="tab-content">
                        <div class="admin-title">📄 תמלולים אחרונים</div>
                        <div class="table-container">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>תאריך</th>
                                        <th>משתמש</th>
                                        <th>שם קובץ</th>
                                        <th>משך</th>
                                        <th>שפה</th>
                                        <th>סטטוס</th>
                                        <th>הורדה</th>
                                    </tr>
                                </thead>
                                <tbody id="transcriptionsTableBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Add Minutes Tab -->
                    <div id="addMinutesTab" class="tab-content">
                        <div class="admin-title">🔧 הוספת דקות</div>
                        <div class="admin-controls">
                            <div>
                                <div class="form-group">
                                    <label for="adminUserEmail">אימייל לקוח:</label>
                                    <input type="email" id="adminUserEmail" placeholder="הכנס אימייל לקוח">
                                </div>
                                <div class="form-group">
                                    <label for="adminMinutesToAdd">דקות להוספה:</label>
                                    <input type="number" id="adminMinutesToAdd" min="1" placeholder="מספר דקות">
                                </div>
                            </div>
                            <button class="btn" onclick="addMinutesToUser()">הוסף דקות</button>
                        </div>

                        <div style="margin-top: 15px; padding: 10px; background: rgba(255, 193, 7, 0.2); border-radius: 5px; font-size: 0.9em;">
                            <strong>💡 טיפ:</strong> בחר משתמש מהרשימה למעלה
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transcribe Tab -->
            <div id="transcribeTab" class="tab-content">
                <form id="transcriptionForm">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">📁</div>
                        <div class="upload-text">לחץ כאן או גרור קבצים (ללא הגבלה)</div>
                        <div class="upload-subtext">תומך בפורמטים: MP3, MP4, WAV, M4A, MOV, AVI, MKV</div>
                        <div style="margin-top: 10px; font-size: 0.8em; color: #3b82f6;">
                            ✨ תמלול עם Gemini 2.5 Pro → קובץ Word מסודר ומעוצב
                        </div>
                        <div style="margin-top: 8px; font-size: 0.85em; color: #28a745; font-weight: 600;">
                            🎯 שיעורים בעברית - 98% דיוק • שיעורים בהגייה ישיבתית - 95% דיוק
                        </div>
                        <div style="margin-top: 8px; font-size: 0.8em; color: #6b7280; background-color: #f3f4f6; padding: 8px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                            📏 <strong>מגבלות:</strong> עד 500MB לקובץ בודד • ללא הגבלה על מספר קבצים
                        </div>
                        <input type="file" id="fileInput" class="file-input" accept="audio/*,video/*" multiple>
                        <input type="file" id="folderInput" class="file-input" webkitdirectory directory multiple accept="audio/*,video/*" style="display: none;">
                    </div>

                    <!-- Upload options buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                        <button type="button" class="btn-upload-option" onclick="selectFiles()">
                            📄 בחר קבצים
                        </button>
                        <button type="button" class="btn-upload-option" onclick="selectFolder()" title="בחר תיקייה עם כל הקבצים שבתוכה">
                            📂 בחר תיקייה שלמה
                        </button>
                        <!-- Google Drive integration - ready but disabled for now -->
                        <button type="button" class="btn-upload-option" onclick="selectFromGoogleDrive()" title="בחר קבצים מ-Google Drive" style="display: none;">
                            🔗 Google Drive
                        </button>
                    </div>

                    <div id="selectedFiles"></div>

                    <!-- Folder preview (shown when folder is selected) -->
                    <div id="folderPreview" class="folder-preview">
                        <div class="folder-title">📂 קבצים בתיקייה: <span id="folderName"></span></div>
                        <div class="folder-files" id="folderFiles">
                            <!-- Files will be populated here -->
                        </div>
                        <div class="folder-actions">
                            <button type="button" class="btn-secondary" onclick="selectAllFolderFiles()">
                                ✅ בחר הכל
                            </button>
                            <button type="button" class="btn-secondary" onclick="deselectAllFolderFiles()">
                                ❌ בטל הכל
                            </button>
                            <button type="button" class="btn" onclick="addSelectedFolderFiles()">
                                ➕ הוסף קבצים נבחרים
                            </button>
                        </div>
                    </div>

                    <!-- Clear all button (shown when files are selected) -->
                    <div id="clearAllContainer" style="display: none; margin: 15px 0; text-align: center;">
                        <button type="button" class="btn-clear-all" onclick="clearAllFiles()">
                            🗑️ נקה הכל
                        </button>
                    </div>

                    <div id="estimatedCost" style="display: none;" class="insufficient-minutes">
                        <strong>אמידת זמן תמלול:</strong> <span id="estimatedMinutes">0</span> דקות<br>
                        <strong>יתרה נוכחית:</strong> <span id="currentBalance">0</span> דקות
                    </div>


                    <div class="form-group">
                        <label for="customInstructions">הנחייה אישית (אופציונלי):</label>
                        <textarea id="customInstructions" placeholder="" rows="3" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; transition: border-color 0.3s ease; resize: vertical; font-family: inherit;"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="language">שפת התמלול:</label>
                        <select id="language">
                            <option value="he">עברית</option>
                            <option value="yi">אידיש</option>
                            <option value="en">אנגלית</option>
                            <option value="fr">צרפתית</option>
                            <option value="es">ספרדית</option>
                            <option value="ru">רוסית</option>
                        </select>
                    </div>

                    <button type="submit" class="btn" id="submitBtn" disabled>
                        🚀 התחל תמלול
                    </button>

                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>

                    <div class="status" id="status"></div>
                </form>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <h3>היסטוריית תמלולים</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>שם הקובץ</th>
                            <th>משך זמן</th>
                            <th>שפה</th>
                            <th>סטטוס</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History items will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Payment Tab -->
            <div id="paymentTab" class="tab-content">
                <h3>רכישת דקות תמלול</h3>
               <div class="payment-options">
    <div class="payment-option" onclick="selectPaymentOption(this, 60, 10)">
        <div class="payment-amount">60</div>
        <div class="payment-minutes">דקות תמלול</div>
        <div class="payment-price">₪10</div>
    </div>
</div>
                <button class="btn" id="purchaseBtn" disabled onclick="processPurchase()">
                    💳 לתשלום
                </button>
            </div>
        </div>

       <div class="features">
            <h3>🌟 מה מיוחד בשירות שלנו?</h3>
            <ul>
                <li>תמלול מתקדם עם Gemini 2.5 Pro</li>
                <li>קובץ Word מסודר ומעוצב בעברית</li>
                <li>עיבוד אוטומטי ומהיר</li>
                <li>מערכת ניהול דקות אישית</li>
                <li>תמיכה במגוון פורמטים</li>
                <li>זיהוי רב-לשוני מתקדם</li>
                <li>שליחה אוטומטית למייל</li>
                <li>היסטוריה מלאה והורדת קבצים</li>
            </ul>
       </div>
    </div>

    <!-- Cookie Consent Banner -->
    <div id="cookieBanner" class="cookie-banner" style="display: none;">
        <div class="cookie-banner-content">
            <div class="cookie-banner-text">
                <h4>שימוש בעוגיות</h4>
                <p>האתר שלנו משתמש בעוגיות כדי לשפר את החוויה שלך, לזכור את פרטי ההתחברות ולהבטיח פעולה תקינה של המערכת.</p>
            </div>
            <div class="cookie-banner-buttons">
                <button class="cookie-btn cookie-btn-accept" onclick="acceptCookies()">
                    ✅ אישור
                </button>
                <button class="cookie-btn cookie-btn-decline" onclick="declineCookies()">
                    ❌ דחייה
                </button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = '/api';
        
        // Global state
        let currentUser = null;
        let cookiesAccepted = false;

        // Save user to localStorage
        function saveUserToStorage(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
        }

        // Load user from localStorage
        function loadUserFromStorage() {
            const stored = localStorage.getItem('currentUser');
            if (stored) {
                try {
                    currentUser = JSON.parse(stored);
                    return currentUser;
                } catch (e) {
                    console.error('Error parsing stored user:', e);
                    localStorage.removeItem('currentUser');
                }
            }
            return null;
        }

        // Clear user from storage
        function clearUserFromStorage() {
            localStorage.removeItem('currentUser');
        }

        // Cookie consent functions
        function checkCookieConsent() {
            const consent = localStorage.getItem('cookieConsent');
            if (consent === null) {
                // Show banner if no choice made yet
                document.getElementById('cookieBanner').style.display = 'block';
                return false;
            }
            cookiesAccepted = consent === 'accepted';
            return true;
        }

        function acceptCookies() {
            localStorage.setItem('cookieConsent', 'accepted');
            cookiesAccepted = true;
            document.getElementById('cookieBanner').style.display = 'none';
            console.log('✅ Cookies accepted');
        }

        function declineCookies() {
            localStorage.setItem('cookieConsent', 'declined');
            cookiesAccepted = false;
            document.getElementById('cookieBanner').style.display = 'none';
            console.log('❌ Cookies declined - using localStorage only');
        }
        let selectedFiles = [];
        let selectedPayment = null;
        let currentTranscriptionId = null; // Track current transcription for cancellation
        let folderFiles = []; // Store folder files for preview

        // Debug function
        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.innerHTML = `🔧 ${message}`;
            }
        }

        // Check for stored user on page load
        async function checkStoredUser() {
            const storedUser = loadUserFromStorage();
            if (storedUser) {
                console.log('🔄 משחזר משתמש מאוחסן:', storedUser.email);
                currentUser = storedUser;

                // Sync with server to get latest data
                try {
                    console.log('🔄 מסנכרן נתונים עם השרת...');
                    const response = await fetch(`${API_BASE}/user-sync`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: storedUser.email })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.user) {
                            // Update with fresh server data
                            currentUser = data.user;
                            saveUserToStorage(currentUser);
                            console.log('✅ נתונים מעודכנים מהשרת');
                        }
                    }
                } catch (error) {
                    console.log('⚠️ לא ניתן לסנכרן עם השרת, משתמש בנתונים מקומיים');
                }

                updateDashboard();
                showApp();
                return true;
            }
            return false;
        }

        // Test API connectivity on load
        async function testAPI() {
            try {
                updateDebugInfo('בודק קישור ל-API...');
                const response = await fetch(`${API_BASE}/test`);
                const data = await response.json();
                
                if (data.success) {
                    updateDebugInfo('✅ API מחובר ועובד!');
                    setTimeout(() => {
                        const debugInfo = document.getElementById('debugInfo');
                        if (debugInfo) debugInfo.style.display = 'none';
                    }, 3000);
                } else {
                    updateDebugInfo('⚠️ API לא מגיב כראוי');
                }
            } catch (error) {
                updateDebugInfo(`❌ שגיאה בחיבור API: ${error.message}`);
                console.error('API Test failed:', error);
            }
        }

        // Tab switching functions
        function switchTab(tabName) {
            document.querySelectorAll('#authSection .nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#authSection .tab-content').forEach(content => content.classList.remove('active'));

            // Find and activate the correct tab button
            const tabButton = document.querySelector(`#authSection .nav-tab[onclick*="${tabName}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }

            document.getElementById(tabName + 'Tab').classList.add('active');

            // Clear auth status when switching tabs
            const authStatus = document.getElementById('authStatus');
            const registerAuthStatus = document.getElementById('registerAuthStatus');
            if (authStatus) {
                authStatus.style.display = 'none';
            }
            if (registerAuthStatus) {
                registerAuthStatus.style.display = 'none';
            }
        }

        function switchAppTab(tabName) {
            document.querySelectorAll('#appSection .nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#appSection .tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'admin') {
                loadAdminData();
            }
        }

        // 🔧 NEW: Admin tab switching
        function switchAdminTab(tabName) {
            document.querySelectorAll('#adminPanel .nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#adminPanel .tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load data based on tab
            switch(tabName) {
                case 'overview':
                    loadAdminOverview();
                    break;
                case 'users':
                    loadAdminUsers();
                    break;
                case 'transcriptions':
                    loadAdminTranscriptions();
                    break;
            }
        }

        // 🔧 NEW: Load admin data when tab is opened
        function loadAdminData() {
            loadAdminOverview();
            loadAdminUsers();
            loadAdminTranscriptions();
        }

        // Authentication functions with better error handling
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            updateDebugInfo('מנסה להתחבר...');

            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error('השרת החזיר תגובה לא תקינה');
                }

                const data = await response.json();
                console.log('Login response:', data);
                
                if (data.success) {
                    currentUser = data.user;
                    saveUserToStorage(currentUser);
                    showAuthStatus('✅ התחברת בהצלחה!', 'success');
                    updateDebugInfo('✅ התחברות הצליחה!');
                    setTimeout(() => showApp(), 1000); // Small delay to show success message
                } else if (data.needsVerification) {
                    // Redirect to verification if email not verified
                    document.getElementById('verificationEmail').value = data.email;

                    // Hide all tabs
                    document.querySelectorAll('#authSection .tab-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    // Show verification tab
                    document.getElementById('verificationTab').classList.add('active');

                    showVerificationStatus(data.error || 'נדרש אימות מייל', 'error');
                } else {
                    showAuthStatus(data.error || 'שגיאה בהתחברות', 'error');
                    updateDebugInfo(`❌ התחברות נכשלה: ${data.error}`);
                }
            } catch (error) {
                console.error('Login error:', error);
                if (error.message.includes('429')) {
                    showAuthStatus('יותר מדי ניסיונות התחברות. נסה שוב מאוחר יותר.', 'error');
                } else {
                    showAuthStatus(`שגיאה בחיבור: ${error.message}`, 'error');
                }
                updateDebugInfo(`❌ שגיאה: ${error.message}`);
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const phone = document.getElementById('registerPhone').value;

            updateDebugInfo('מנסה להירשם...');

            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ name, email, password, phone })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error('השרת החזיר תגובה לא תקינה');
                }

                const data = await response.json();
                console.log('Register response:', data);
                console.log('needsVerification:', data.needsVerification);
                console.log('success:', data.success);
                
                if (data.success) {
                    if (data.needsVerification) {
                        // Registration successful, needs email verification
                        document.getElementById('verificationEmail').value = email;

                        // Hide all tabs
                        document.querySelectorAll('#authSection .tab-content').forEach(content => {
                            content.classList.remove('active');
                        });

                        // Show verification tab
                        document.getElementById('verificationTab').classList.add('active');

                        showVerificationStatus(data.message || 'נשלח אליך מייל עם קוד אימות', 'success');
                        updateDebugInfo('✅ הרשמה הצליחה! נדרש אימות מייל');
                    } else {
                        // Legacy path for existing users (shouldn't happen with new logic)
                        currentUser = data.user;
                        saveUserToStorage(currentUser);
                        showAuthStatus('✅ ההרשמה הושלמה בהצלחה!', 'success');
                        updateDebugInfo('✅ הרשמה הצליחה!');
                        setTimeout(() => showApp(), 2000);
                    }
                } else {
                    showAuthStatus(data.error || 'שגיאה בהרשמה', 'error');
                    updateDebugInfo(`❌ הרשמה נכשלה: ${data.error}`);
                }
            } catch (error) {
                console.error('Register error:', error);
                if (error.message.includes('429')) {
                    showAuthStatus('יותר מדי הרשמות. נסה שוב מאוחר יותר.', 'error');
                } else {
                    showAuthStatus(`שגיאה בחיבור: ${error.message}`, 'error');
                }
                updateDebugInfo(`❌ שגיאה: ${error.message}`);
            }
        });

        function showApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            updateDashboard();
        }

        // Email verification form handler
        document.getElementById('verificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('verificationEmail').value;
            const verificationCode = document.getElementById('verificationCode').value;

            updateDebugInfo('מאמת קוד...');

            try {
                const response = await fetch(`${API_BASE}/verify-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ email, verificationCode })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Verification response:', data);

                if (data.success) {
                    currentUser = data.user;
                    saveUserToStorage(currentUser);
                    showVerificationStatus('✅ המייל אומת בהצלחה!', 'success');
                    updateDebugInfo('✅ אימות הצליח!');
                    setTimeout(() => showApp(), 2000);
                } else {
                    showVerificationStatus(data.error || 'שגיאה באימות', 'error');
                    updateDebugInfo(`❌ אימות נכשל: ${data.error}`);
                }
            } catch (error) {
                console.error('Verification error:', error);
                if (error.message.includes('429')) {
                    showVerificationStatus('יותר מדי ניסיונות אימות. נסה שוב מאוחר יותר.', 'error');
                } else {
                    showVerificationStatus(`שגיאה בחיבור: ${error.message}`, 'error');
                }
                updateDebugInfo(`❌ שגיאה: ${error.message}`);
            }
        });

        // Show verification status
        function showVerificationStatus(message, type) {
            const statusDiv = document.getElementById('verificationAuthStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }

        function logout() {
            currentUser = null;
            clearUserFromStorage();
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
            // הסרנו את המילוי האוטומטי של פרטי האדמין מסיבות אבטחה
        }

        function updateDashboard() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('remainingMinutes').textContent = currentUser.remainingMinutes;
            document.getElementById('totalTranscribed').textContent = currentUser.totalTranscribed;

            // Show admin panel if user is admin
            if (currentUser.isAdmin) {
                document.getElementById('adminPanel').style.display = 'block';
                console.log('🔧 Admin panel displayed for user:', currentUser.email);
            } else {
                document.getElementById('adminPanel').style.display = 'none';
            }
        }

        // Admin function to add minutes to user
        async function addMinutesToUser() {
            console.log('🔧 Admin function called');
            console.log('🔧 Current user:', currentUser);
            
            const email = document.getElementById('adminUserEmail').value.trim();
            const minutes = parseInt(document.getElementById('adminMinutesToAdd').value);
            
            console.log('🔧 Input values:', { email, minutes });
            
            // Check admin permissions
            if (!currentUser || !currentUser.isAdmin) {
                showStatus('❌ אין הרשאות מנהל', 'error');
                return;
            }
            
            if (!email || !minutes || minutes <= 0) {
                showStatus('❌ אנא מלא את כל השדות עם ערכים תקינים', 'error');
                return;
            }
            
            try {
                showStatus('<div class="spinner"></div>מוסיף דקות...', 'processing');
                
                console.log('🔧 Sending request to server...');
                
                const requestBody = { 
                    userEmail: email, 
                    minutes: minutes 
                };
                
                console.log('🔧 Request body:', requestBody);
                
                const response = await fetch('/api/admin/add-minutes', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('🔧 Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('🔧 Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('🔧 Success response:', data);
                
                if (data.success) {
                    showStatus(`✅ הצלחה! נוספו ${minutes} דקות למשתמש ${email}<br>יתרה ישנה: ${data.oldBalance} → יתרה חדשה: ${data.newBalance} דקות`, 'success');
                    
                    // Clear fields
                    document.getElementById('adminUserEmail').value = '';
                    document.getElementById('adminMinutesToAdd').value = '';
                    
                    // Update dashboard if this is the current user
                    if (currentUser && currentUser.email === email) {
                        currentUser.remainingMinutes = data.newBalance;
                        saveUserToStorage(currentUser);
                        updateDashboard();
                    }
                } else {
                    showStatus(`❌ שגיאה: ${data.error}`, 'error');
                }
                
            } catch (error) {
                console.error('🔧 Add minutes error:', error);
                showStatus(`❌ שגיאה בהוספת דקות: ${error.message}`, 'error');
            }
        }

        // Real audio/video duration detection with better error handling
        function getRealAudioDuration(file) {
            return new Promise((resolve) => {
                console.log(`🎵 קורא משך זמן אמיתי לקובץ: ${file.name}`);

                const url = URL.createObjectURL(file);
                const mediaElement = document.createElement(file.type.startsWith('video/') ? 'video' : 'audio');

                let resolved = false;

                const cleanup = () => {
                    URL.revokeObjectURL(url);
                    mediaElement.src = '';
                };

                const resolveWithFallback = () => {
                    if (!resolved) {
                        resolved = true;
                        cleanup();

                        // Fallback to file size estimation only if real duration fails
                        const fileSizeMB = file.size / (1024 * 1024);
                        const ext = file.name.toLowerCase().split('.').pop();
                        let estimatedMinutes;

                        if (['mp4', 'mov', 'avi', 'mkv'].includes(ext)) {
                            estimatedMinutes = Math.max(1, Math.ceil(fileSizeMB / 3));
                        } else {
                            estimatedMinutes = Math.max(1, Math.ceil(fileSizeMB / 1.2));
                        }

                        console.log(`⚠️ ${file.name} - נכשל בקריאת זמן אמיתי, הערכה: ${estimatedMinutes} דקות`);
                        resolve(estimatedMinutes);
                    }
                };

                // Success: got real duration
                mediaElement.addEventListener('loadedmetadata', () => {
                    if (!resolved && !isNaN(mediaElement.duration) && mediaElement.duration > 0) {
                        resolved = true;
                        const durationSeconds = mediaElement.duration;
                        const durationMinutes = Math.ceil(durationSeconds / 60);
                        cleanup();

                        console.log(`✅ ${file.name} - זמן אמיתי: ${durationSeconds.toFixed(1)}s (${durationMinutes} דקות)`);
                        resolve(durationMinutes);
                    }
                }, { once: true });

                // Error handling
                mediaElement.addEventListener('error', resolveWithFallback, { once: true });

                // Timeout after 1.5 seconds
                setTimeout(resolveWithFallback, 1500);

                // Start loading
                mediaElement.src = url;
                mediaElement.load();
            });
        }

        // File upload functions
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectedFilesDiv = document.getElementById('selectedFiles');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            console.log(`🎯 גרירת קבצים: ${e.dataTransfer.files.length} קבצים`);
            // Create a copy of files array to avoid reference issues
            const filesArray = Array.from(e.dataTransfer.files);
            handleFiles(filesArray, true); // true = add to existing files
        });

        fileInput.addEventListener('change', (e) => {
            console.log(`📁 בחירת קבצים דרך File Input: ${e.target.files.length} קבצים`);
            if (e.target.files.length > 0) {
                // Create a copy of files array to avoid reference issues
                const filesArray = Array.from(e.target.files);
                handleFiles(filesArray, true); // true = add to existing files
            }
        });

        // Note: Folder input listener is now created dynamically in selectFolder() function

        // Upload option functions
        function selectFiles() {
            fileInput.click();
        }

        function selectFolder() {
            console.log('📂 פותח דיאלוג בחירת תיקייה');

            // Remove existing input completely
            const existingInput = document.getElementById('folderInput');
            if (existingInput) {
                existingInput.remove();
            }

            // Create completely new input with folder attributes set from the beginning
            const newInput = document.createElement('input');
            newInput.type = 'file';
            newInput.id = 'folderInput';
            newInput.className = 'file-input';
            newInput.style.display = 'none';

            // Set folder-specific attributes BEFORE adding to DOM
            newInput.webkitdirectory = true;
            newInput.directory = true;
            newInput.multiple = true;
            newInput.accept = 'audio/*,video/*';

            // Add event listener
            newInput.addEventListener('change', (e) => {
                console.log(`📂 בחירת תיקייה: ${e.target.files.length} קבצים`);
                if (e.target.files.length === 0) {
                    console.log('📂 לא נבחרו קבצים - המשתמש ביטל');
                    return;
                }
                handleFolderSelection(e.target.files);
            });

            // Add to DOM
            document.body.appendChild(newInput);

            // Trigger immediately
            newInput.click();
            console.log('📂 דיאלוג בחירת תיקייה הופעל');
        }

        // Handle folder selection and preview
        async function handleFolderSelection(files) {
            console.log(`📂 מעבד תיקייה עם ${files.length} קבצים`);

            // Filter valid audio/video files
            const validFiles = Array.from(files).filter(file =>
                file.type.startsWith('audio/') ||
                file.type.startsWith('video/') ||
                file.name.toLowerCase().match(/\.(mp3|mp4|wav|m4a|mov|avi|mkv|flac|aac|ogg)$/)
            );

            if (validFiles.length === 0) {
                showStatus('לא נמצאו קבצי אודיו או וידאו תקינים בתיקייה', 'error');
                return;
            }

            // Get folder name from first file
            const folderPath = files[0].webkitRelativePath;
            const folderName = folderPath.split('/')[0];

            console.log(`📂 תיקייה: ${folderName}, קבצים תקינים: ${validFiles.length}/${files.length}`);

            // Check for large folders and limit processing
            const MAX_FILES = 200; // Maximum files to process at once
            let filesToProcess = validFiles;
            let showingLimitedFiles = false;

            if (validFiles.length > MAX_FILES) {
                showingLimitedFiles = true;
                filesToProcess = validFiles.slice(0, MAX_FILES);

                showStatus(`⚠️ תיקייה גדולה: ${validFiles.length} קבצים. מציג ${MAX_FILES} הראשונים לביצועים טובים יותר`, 'processing');

                // Show warning in console
                console.log(`⚠️ תיקייה גדולה: ${validFiles.length} קבצים, מעבד רק ${MAX_FILES} ראשונים`);
            }

            // Store files and show preview
            folderFiles = filesToProcess;
            await showFolderPreview(folderName, filesToProcess, showingLimitedFiles, validFiles.length);
        }

        // Show folder preview with file list
        async function showFolderPreview(folderName, files, showingLimitedFiles = false, totalFiles = 0) {
            const folderTitle = showingLimitedFiles
                ? `${folderName} (מציג ${files.length} מתוך ${totalFiles} קבצים)`
                : folderName;

            document.getElementById('folderName').textContent = folderTitle;
            const folderFilesDiv = document.getElementById('folderFiles');
            const folderPreview = document.getElementById('folderPreview');

            // Clear previous files
            folderFilesDiv.innerHTML = '';

            // Add warning message for limited files
            if (showingLimitedFiles) {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = 'background: rgba(255, 152, 0, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; border-right: 3px solid #ff9800; text-align: center; color: #e65100; font-weight: 600;';
                warningDiv.innerHTML = `⚠️ תיקייה גדולה: מציג ${files.length} קבצים ראשונים מתוך ${totalFiles} לביצועים מיטביים`;
                folderFilesDiv.appendChild(warningDiv);
            }

            // Create progress div
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = 'background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;';
            progressDiv.innerHTML = '<div class="spinner"></div>מעבד קבצים... <span id="folderProgress">0/${files.length}</span>';
            folderFilesDiv.appendChild(progressDiv);

            // Process files in parallel batches
            const BATCH_SIZE = 10; // Process 10 files simultaneously
            let processedCount = 0;

            const updateProgress = () => {
                const progressSpan = document.getElementById('folderProgress');
                if (progressSpan) {
                    progressSpan.textContent = `${processedCount}/${files.length}`;
                }
            };

            const processFileBatch = async (batch, startIndex) => {
                const promises = batch.map(async (file, batchIndex) => {
                    const i = startIndex + batchIndex;
                    try {
                        const duration = await getRealAudioDuration(file);

                        const fileItem = document.createElement('div');
                        fileItem.className = 'folder-file-item';
                        fileItem.innerHTML = `
                            <input type="checkbox" class="folder-file-checkbox" checked data-index="${i}">
                            <div class="folder-file-info">
                                <div class="folder-file-name">${getFileTypeIcon(file.type, file.name)} ${file.name}</div>
                                <div class="folder-file-size">📏 ${formatFileSize(file.size)} • ⏱️ ${duration} דקות</div>
                            </div>
                        `;

                        // Store duration info
                        file.estimatedDuration = duration;

                        processedCount++;
                        updateProgress();

                        return fileItem;

                    } catch (error) {
                        console.error('Error processing file:', file.name, error);

                        const fileItem = document.createElement('div');
                        fileItem.className = 'folder-file-item';
                        fileItem.innerHTML = `
                            <input type="checkbox" class="folder-file-checkbox" checked data-index="${i}">
                            <div class="folder-file-info">
                                <div class="folder-file-name">${getFileTypeIcon(file.type, file.name)} ${file.name}</div>
                                <div class="folder-file-size">📏 ${formatFileSize(file.size)} • ⚠️ לא ניתן לקרוא זמן</div>
                            </div>
                        `;

                        // Fallback duration estimate
                        const fileSizeMB = file.size / (1024 * 1024);
                        const ext = file.name.toLowerCase().split('.').pop();
                        file.estimatedDuration = ['mp4', 'mov', 'avi', 'mkv'].includes(ext)
                            ? Math.max(1, Math.ceil(fileSizeMB / 3))
                            : Math.max(1, Math.ceil(fileSizeMB / 1.2));

                        processedCount++;
                        updateProgress();

                        return fileItem;
                    }
                });

                const fileItems = await Promise.all(promises);

                // Add items to DOM in order
                fileItems.forEach(item => {
                    folderFilesDiv.appendChild(item);
                });
            };

            // Process all files in batches
            for (let i = 0; i < files.length; i += BATCH_SIZE) {
                const batch = files.slice(i, i + BATCH_SIZE);
                await processFileBatch(batch, i);
            }

            // Remove progress div
            progressDiv.remove();

            // Show the preview
            folderPreview.style.display = 'block';

            const statusMessage = showingLimitedFiles
                ? `✅ מעובד ${files.length} קבצים מתוך ${totalFiles} בתיקייה "${folderName}"`
                : `✅ נמצאו ${files.length} קבצים בתיקייה "${folderName}"`;

            showStatus(statusMessage, 'success');

            setTimeout(() => {
                const status = document.getElementById('status');
                if (status) status.style.display = 'none';
            }, 3000);
        }

        // Folder management functions
        function selectAllFolderFiles() {
            const checkboxes = document.querySelectorAll('.folder-file-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        function deselectAllFolderFiles() {
            const checkboxes = document.querySelectorAll('.folder-file-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        function addSelectedFolderFiles() {
            const checkboxes = document.querySelectorAll('.folder-file-checkbox:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));

            if (selectedIndices.length === 0) {
                showStatus('אנא בחר לפחות קובץ אחד', 'error');
                return;
            }

            const filesToAdd = selectedIndices.map(index => ({
                file: folderFiles[index],
                duration: folderFiles[index].estimatedDuration || 1
            }));

            console.log(`📂 מוסיף ${filesToAdd.length} קבצים מהתיקייה`);

            // Add files to selectedFiles (avoid duplicates)
            filesToAdd.forEach(item => {
                const isDuplicate = selectedFiles.some(selected =>
                    selected.file.name === item.file.name &&
                    selected.file.size === item.file.size &&
                    selected.file.lastModified === item.file.lastModified
                );

                if (!isDuplicate) {
                    selectedFiles.push(item);
                    displayFile(item.file, item.duration);
                }
            });

            // Update UI
            updateSubmitButton();
            updateCostEstimate();

            // Hide folder preview
            document.getElementById('folderPreview').style.display = 'none';

            showStatus(`✅ נוספו ${filesToAdd.length} קבצים מהתיקייה לרשימת התמלול`, 'success');
            setTimeout(() => {
                const status = document.getElementById('status');
                if (status) status.style.display = 'none';
            }, 2000);

            // Reset folder input
            folderInput.value = '';
        }


        async function handleFiles(files, addToExisting = false) {
            console.log(`🔄 טיפול בקבצים: ${files.length} קבצים, הוספה לקיימים: ${addToExisting}`);
            console.log('📁 קבצים שהתקבלו:', Array.from(files).map(f => `${f.name} (${f.size} bytes)`));
            console.log('📋 קבצים נבחרים כרגע:', selectedFiles.map(item => `${item.file.name} (${item.file.size} bytes)`));

            const validFiles = Array.from(files).filter(file =>
                file.type.startsWith('audio/') ||
                file.type.startsWith('video/') ||
                file.name.toLowerCase().match(/\.(mp3|mp4|wav|m4a|mov|avi|mkv|flac|aac|ogg)$/)
            );

            console.log(`✅ קבצים תקינים: ${validFiles.length}/${files.length}`);

            if (validFiles.length === 0) {
                showStatus('אנא בחר קבצי אודיו או וידאו תקינים', 'error');
                return;
            }

            // Check for files that exceed the size limit (500MB)
            const maxFileSize = 500 * 1024 * 1024; // 500MB in bytes
            const oversizedFiles = validFiles.filter(file => file.size > maxFileSize);

            if (oversizedFiles.length > 0) {
                const oversizedNames = oversizedFiles.map(file =>
                    `${file.name} (${(file.size / (1024 * 1024)).toFixed(1)}MB)`
                ).join('<br>');

                showStatus(
                    `❌ <strong>קבצים גדולים מדי!</strong><br>המגבלה היא 500MB לקובץ<br><br>קבצים שחורגים:<br>${oversizedNames}`,
                    'error'
                );
                return;
            }

            // Filter out files that are already selected (prevent duplicates)
            const newFiles = validFiles.filter(file => {
                const isDuplicate = selectedFiles.some(selected =>
                    selected.file.name === file.name &&
                    selected.file.size === file.size &&
                    selected.file.lastModified === file.lastModified
                );

                if (isDuplicate) {
                    console.log(`🔄 קובץ כפול נמנע: ${file.name}`);
                }

                return !isDuplicate;
            });

            console.log(`🔍 קבצים חדשים לעיבוד: ${newFiles.length}/${validFiles.length}`);
            console.log('🆕 קבצים חדשים:', newFiles.map(f => f.name));

            if (newFiles.length < validFiles.length) {
                console.log(`⚠️ ${validFiles.length - newFiles.length} קבצים נמנעו בגלל כפילות`);
            }

            if (newFiles.length === 0 && addToExisting) {
                showStatus('כל הקבצים שנבחרו כבר קיימים ברשימה', 'error');
                fileInput.value = ''; // Reset the input
                setTimeout(() => {
                    const status = document.getElementById('status');
                    if (status) status.style.display = 'none';
                }, 3000);
                return;
            }

            // Clear existing files only if not adding to existing
            if (!addToExisting) {
                selectedFiles = [];
                selectedFilesDiv.innerHTML = '';
            }

            const filesToProcess = addToExisting ? newFiles : validFiles;

            if (filesToProcess.length > 0) {
                console.log(`📁 מוסיף ${filesToProcess.length} קבצים עם זמן אמיתי`);
                showStatus('<div class="spinner"></div>קורא זמן אמיתי לקבצים...', 'processing');

                // Process each file to get real duration
                let processedCount = 0;

                const processFile = async (file) => {
                    try {
                        const duration = await getRealAudioDuration(file);

                        selectedFiles.push({
                            file: file,
                            duration: duration
                        });

                        displayFile(file, duration);
                        processedCount++;

                        console.log(`✅ ${file.name} → ${duration} דקות (זמן אמיתי)`);

                        // Update progress
                        showStatus(`<div class="spinner"></div>קורא זמן: ${processedCount}/${filesToProcess.length} קבצים...`, 'processing');

                    } catch (error) {
                        console.error('Error reading duration for:', file.name, error);

                        // Fallback to size estimation
                        const fileSizeMB = file.size / (1024 * 1024);
                        const ext = file.name.toLowerCase().split('.').pop();
                        const estimatedDuration = ['mp4', 'mov', 'avi', 'mkv'].includes(ext)
                            ? Math.max(1, Math.ceil(fileSizeMB / 3))
                            : Math.max(1, Math.ceil(fileSizeMB / 1.2));

                        selectedFiles.push({
                            file: file,
                            duration: estimatedDuration
                        });

                        displayFile(file, estimatedDuration);
                        processedCount++;

                        console.log(`⚠️ ${file.name} → ${estimatedDuration} דקות (הערכה)`);

                        // Update progress
                        showStatus(`<div class="spinner"></div>קורא זמן: ${processedCount}/${filesToProcess.length} קבצים...`, 'processing');
                    }
                };

                // Process files sequentially
                for (const file of filesToProcess) {
                    await processFile(file);
                }

                // Update UI after all files processed
                updateSubmitButton();
                updateCostEstimate();

                // Show completion message (no total duration)
                if (addToExisting) {
                    showStatus(`✅ נוספו ${filesToProcess.length} קבצים לרשימה - סה"כ ${selectedFiles.length} קבצים`, 'success');
                } else {
                    showStatus(`✅ נבחרו ${filesToProcess.length} קבצים לתמלול`, 'success');
                }

                setTimeout(() => {
                    const status = document.getElementById('status');
                    if (status) status.style.display = 'none';
                }, 2000);
            }

            // Final update (only if no files were processed above)
            if (filesToProcess.length === 0) {
                updateSubmitButton();
                updateCostEstimate();
            }

            // Reset file input after a small delay to ensure processing is complete
            setTimeout(() => {
                fileInput.value = '';
            }, 100);
        }

        function displayFile(file, duration) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'selected-file';
            fileDiv.setAttribute('data-filename', file.name);
            
            const fileSizeFormatted = formatFileSize(file.size);
            const fileTypeIcon = getFileTypeIcon(file.type, file.name);
            
            fileDiv.innerHTML = `
                <div class="file-info">
                    <div>
                        <div class="file-name">${fileTypeIcon} ${file.name}</div>
                        <div class="file-size">📏 גודל: ${fileSizeFormatted}</div>
                        <div class="file-duration">⏱️ משך זמן: ${duration} דקות</div>
                        <div class="file-type" style="font-size: 0.8em; color: #888;">סוג: ${getFileTypeDescription(file.type, file.name)}</div>
                    </div>
                    <button type="button" class="remove-file" onclick="removeFile('${file.name}')">×</button>
                </div>
            `;
            selectedFilesDiv.appendChild(fileDiv);
        }

        function getFileTypeIcon(mimeType, fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            
            if (mimeType.startsWith('video/') || ['mp4', 'mov', 'avi', 'mkv'].includes(ext)) {
                return '🎬';
            } else if (mimeType.startsWith('audio/') || ['mp3', 'wav', 'm4a', 'flac', 'aac', 'ogg'].includes(ext)) {
                return '🎵';
            }
            return '📁';
        }

        function getFileTypeDescription(mimeType, fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            
            const descriptions = {
                'mp3': 'MP3 Audio',
                'wav': 'WAV Audio',
                'm4a': 'M4A Audio',
                'flac': 'FLAC Audio',
                'aac': 'AAC Audio',
                'ogg': 'OGG Audio',
                'mp4': 'MP4 Video',
                'mov': 'MOV Video',
                'avi': 'AVI Video',
                'mkv': 'MKV Video'
            };
            
            return descriptions[ext] || 'קובץ מולטימדיה';
        }

        function removeFile(fileName) {
            selectedFiles = selectedFiles.filter(item => item.file.name !== fileName);
            
            const fileDiv = document.querySelector(`[data-filename="${fileName}"]`);
            if (fileDiv) {
                fileDiv.remove();
            }
            
            updateSubmitButton();
            updateCostEstimate();
        }

        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            const clearAllContainer = document.getElementById('clearAllContainer');

            console.log(`🔘 עדכון כפתורים: ${selectedFiles.length} קבצים נבחרים`);

            submitBtn.disabled = selectedFiles.length === 0;

            // Show/hide clear all container
            if (selectedFiles.length > 0) {
                clearAllContainer.style.display = 'block';
                console.log('✅ מציג כפתור נקה הכל');
            } else {
                clearAllContainer.style.display = 'none';
                console.log('❌ מסתיר כפתור נקה הכל');
            }
        }

        function clearAllFiles() {
            selectedFiles = [];
            selectedFilesDiv.innerHTML = '';

            // Reset file input
            fileInput.value = '';

            updateSubmitButton();
            updateCostEstimate();

            showStatus('✅ כל הקבצים נוקו מהרשימה', 'success');
            setTimeout(() => {
                const status = document.getElementById('status');
                if (status) status.style.display = 'none';
            }, 2000);
        }

        function updateCostEstimate() {
            console.log(`📊 עדכון תצוגה - קבצים נבחרים: ${selectedFiles.length}`);

            if (selectedFiles.length === 0) {
                document.getElementById('estimatedCost').style.display = 'none';
                return;
            }

            // Log each file's duration for debugging
            selectedFiles.forEach((item, index) => {
                console.log(`📄 קובץ ${index + 1}: ${item.file.name} - ${item.duration} דקות`);
            });

            const costDiv = document.getElementById('estimatedCost');
            costDiv.style.display = 'block';
            costDiv.className = 'status success';
            costDiv.innerHTML = `
                <strong>📁 נבחרו ${selectedFiles.length} קבצים לתמלול</strong><br>
                <strong>יתרה נוכחית:</strong> ${currentUser ? currentUser.remainingMinutes : 0} דקות<br>
                <small>💡 זמן התמלול האמיתי יחושב במהלך העיבוד ויתרת הדקות תתעדכן בהתאם</small>
            `;

            // Enable submit button (we'll check balance during transcription)
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').textContent = '🚀 התחל תמלול';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            const size = parseFloat((bytes / Math.pow(k, i)).toFixed(2));
            return `${size} ${sizes[i]}`;
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            if (status) {
                status.className = `status ${type}`;
                status.innerHTML = message;
                status.style.display = 'block';
            }
        }

        function showAuthStatus(message, type) {
            // Determine which tab is active and show status in the correct place
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');

            let status;
            if (loginTab && loginTab.classList.contains('active')) {
                status = document.getElementById('authStatus');
            } else if (registerTab && registerTab.classList.contains('active')) {
                status = document.getElementById('registerAuthStatus');
            } else {
                // Default to login tab status
                status = document.getElementById('authStatus');
            }

            if (status) {
                status.className = `status ${type}`;
                status.innerHTML = message;
                status.style.display = 'block';

                // Auto-hide success messages after 3 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 3000);
                }
            }
        }

        function hideStatus() {
            setTimeout(() => {
                const status = document.getElementById('status');
                if (status && status.classList.contains('processing')) {
                    status.style.display = 'none';
                }
            }, 1000); // Reduced delay for better UX
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // Form submission with real processing
        document.getElementById('transcriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (selectedFiles.length === 0) {
                showStatus('אנא בחר קבצים לתמלול', 'error');
                return;
            }

            const totalMinutes = selectedFiles.reduce((sum, item) => sum + item.duration, 0);
            if (totalMinutes > currentUser.remainingMinutes) {
                showStatus('אין מספיק דקות בחשבון. אנא רכוש דקות נוספות', 'error');
                return;
            }

            const language = document.getElementById('language').value;
            const customInstructions = document.getElementById('customInstructions').value.trim();
            const submitBtn = document.getElementById('submitBtn');

            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ מעבד...';
            document.getElementById('progressBar').style.display = 'block';

            
            showStatus(`
                <div class="spinner"></div>
                <strong>מעבד ${selectedFiles.length} קבצים עם Gemini 2.5 Pro...</strong><br>
                <small>⏱️ זמן כולל: ${totalMinutes} דקות | 🎯 דיוק גבוה: 98% עברית רגילה, 95% הגייה ישיבתית</small><br>
                <small>📧 התוצאות יישלחו למייל ${currentUser.email}</small>
            `, 'processing');

            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 3;
                if (progress > 85) progress = 85;
                updateProgress(progress);
            }, 2000);

            try {
                // Prepare data for both regular files and Google Drive files
                const formData = new FormData();
                const driveFiles = [];

                selectedFiles.forEach((item, index) => {
                    if (item.isGoogleDriveFile) {
                        // Add Google Drive file info
                        driveFiles.push({
                            name: item.name,
                            driveId: item.driveId,
                            size: item.size,
                            type: item.type
                        });
                    } else {
                        // Add regular uploaded file
                        formData.append('files', item.file);
                    }
                });

                // Add metadata
                formData.append('email', currentUser.email);
                formData.append('language', language);
                if (customInstructions) {
                    formData.append('customInstructions', customInstructions);
                }

                // Add Google Drive files as JSON if any
                if (driveFiles.length > 0) {
                    formData.append('driveFiles', JSON.stringify(driveFiles));
                    console.log(`📁 Including ${driveFiles.length} Google Drive files`);
                }

                console.log(`📁 Processing ${selectedFiles.length} total files: ${selectedFiles.filter(f => !f.isGoogleDriveFile).length} uploaded + ${driveFiles.length} from Drive`);

                const response = await fetch(`${API_BASE}/transcribe`, {
                    method: 'POST',
                    body: formData
                });

                // Handle specific HTTP error codes before trying to parse JSON
                if (!response.ok) {
                    if (response.status === 413) {
                        // File too large - try to get the detailed error message
                        try {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'הקובץ גדול מדי! המגבלה היא 500MB');
                        } catch {
                            throw new Error('הקובץ גדול מדי! המגבלה היא 500MB. אנא בחר קובץ קטן יותר.');
                        }
                    }
                    throw new Error(`שגיאה בשרת (${response.status})`);
                }

                const data = await response.json();
                console.log(`📦 Server response data:`, data);

                // Store transcription ID for potential cancellation
                if (data.success && data.transcriptionId) {
                    currentTranscriptionId = data.transcriptionId;
                    console.log(`✅ Stored transcriptionId: ${currentTranscriptionId}`);

                    // Stop fake progress and start real progress checking
                    clearInterval(progressInterval);

                    const realProgressCheck = setInterval(async () => {
                        try {
                            // Skip if no valid transcription ID
                            if (!currentTranscriptionId || currentTranscriptionId === 'null') {
                                console.log(`⏸️ No valid transcription ID: '${currentTranscriptionId}', stopping progress check`);
                                clearInterval(realProgressCheck);
                                return;
                            }

                            console.log(`🔍 Checking progress for transcription: ${currentTranscriptionId}`);
                            const progressResponse = await fetch(`${API_BASE}/transcription-progress/${currentTranscriptionId}`);
                            console.log(`📡 Progress response status: ${progressResponse.status}`);

                            if (progressResponse.ok) {
                                const progressData = await progressResponse.json();
                                console.log(`📊 Progress data received:`, progressData);

                                if (progressData.success && progressData.progress) {
                                    console.log(`📈 Updating progress to: ${progressData.progress.percentage}% - ${progressData.progress.stage}`);
                                    updateProgress(progressData.progress.percentage);

                                    if (progressData.progress.percentage >= 100) {
                                        console.log(`✅ Progress completed, stopping checks`);
                                        clearInterval(realProgressCheck);
                                    }
                                } else {
                                    console.log(`⚠️ No progress data in response`);
                                }
                            } else {
                                console.log(`❌ Progress response not ok: ${progressResponse.status}`);
                            }
                        } catch (e) {
                            console.log(`❌ Progress check error:`, e);
                            // If progress check fails, restart fake progress
                            if (!progressInterval) {
                                console.log(`🔄 Falling back to fake progress`);
                                progressInterval = setInterval(() => {
                                    progress += Math.random() * 2;
                                    if (progress > 85) progress = 85;
                                    updateProgress(progress);
                                }, 3000);
                            }
                        }
                    }, 3000);
                }

                if (data.success) {

                    currentUser.remainingMinutes -= data.estimatedMinutes || totalMinutes;
                    currentUser.totalTranscribed += data.estimatedMinutes || totalMinutes;
                    saveUserToStorage(currentUser);

                    updateDashboard();
                    showStatus(`
                        ✅ <strong>התמלול התחיל בהצלחה!</strong><br>
                        📄 ${selectedFiles.length} קבצי Word מעוצבים יישלחו למייל <strong>${currentUser.email}</strong><br>
                        ⏱️ נוצלו ${data.estimatedMinutes || totalMinutes} דקות מהחשבון<br>
                        💰 יתרה נוכחית: <strong>${currentUser.remainingMinutes} דקות</strong><br>
                        🎯 שיעורים בעברית - 98% דיוק • שיעורים בהגייה ישיבתית - 95% דיוק
                    `, 'success');

                    selectedFiles = [];
                    selectedFilesDiv.innerHTML = '';
                    updateCostEstimate();
                    updateSubmitButton(); // Hide clear all button
                    fileInput.value = '';
                    currentTranscriptionId = null; // Clear transcription tracking
                } else {
                    throw new Error(data.error || 'שגיאה בעיבוד');
                }

            } catch (error) {
                clearInterval(progressInterval);
                showStatus(`❌ <strong>שגיאה:</strong> ${error.message}<br><small>אנא נסה שוב או צור קשר לתמיכה</small>`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '🚀 התחל תמלול מלא';
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                    updateProgress(0);
                }, 3000);
                currentTranscriptionId = null; // Clear transcription tracking
            }
        });


        // Payment functions
        function selectPaymentOption(element, minutes, price) {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            element.classList.add('selected');
            
            selectedPayment = { minutes, price };
            document.getElementById('purchaseBtn').disabled = false;
        }

        function processPurchase() {
            if (!selectedPayment) return;
            
            showStatus('<div class="spinner"></div>מעבד תשלום...', 'processing');
            
            setTimeout(() => {
                currentUser.remainingMinutes += selectedPayment.minutes;
                saveUserToStorage(currentUser);
                updateDashboard();
                
                document.querySelectorAll('.payment-option').forEach(option => {
                    option.classList.remove('selected');
                });
                const minutes = selectedPayment.minutes;
                selectedPayment = null;
                document.getElementById('purchaseBtn').disabled = true;
                
                showStatus(`✅ התשלום בוצע בהצלחה!<br>נוספו ${minutes} דקות לחשבון`, 'success');
            }, 2000);
        }

        // History functions
        function loadHistory() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            // Check both transcriptionHistory and history for backward compatibility
            const userHistory = currentUser?.transcriptionHistory || currentUser?.history || [];

            if (!currentUser || userHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">אין היסטוריה עדיין</td></tr>';
                return;
            }

            // Create a copy and reverse it to show newest first
            [...userHistory].reverse().forEach(item => {
                const row = document.createElement('tr');

                // Handle missing data gracefully
                const displayDate = item.date || new Date(item.timestamp).toLocaleDateString('he-IL') || 'לא זמין';
                const displayFileName = item.fileName || item.originalName || 'קובץ לא ידוע';
                const displayDuration = item.duration || Math.ceil((item.audioLength || 0) / 60) || '0';
                const downloadUrl = item.downloadUrl || item.wordDocumentPath || '';

                row.innerHTML = `
                    <td>${displayDate}</td>
                    <td>${displayFileName}</td>
                    <td>${displayDuration} דקות</td>
                    <td>${getLanguageName(item.language)}</td>
                    <td><span class="status-badge status-${item.status}">${getStatusName(item.status)}</span></td>
                    <td>
                        ${item.status === 'completed' && downloadUrl ?
                          `<button class="btn-secondary" onclick="downloadFile('${downloadUrl}')">📥 הורדה</button>` :
                          '⏳ בעיבוד'
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getLanguageName(code) {
            const languages = {
                'he': 'עברית',
                'yi': 'אידיש',
                'en': 'אנגלית',
                'fr': 'צרפתית',
                'es': 'ספרדית',
                'ru': 'רוסית'
            };
            return languages[code] || code;
        }

        function getStatusName(status) {
            const statuses = {
                'completed': 'הושלם',
                'processing': 'בעיבוד',
                'failed': 'נכשל'
            };
            return statuses[status] || status;
        }

        function downloadFile(url) {
            try {
                // Validate URL before attempting download
                if (!url || url === 'undefined' || url === 'null') {
                    showStatus('❌ קישור ההורדה לא זמין', 'error');
                    return;
                }

                showStatus('⬇️ מתחיל הורדה...', 'processing');

                // Create a temporary anchor element for download
                const link = document.createElement('a');
                link.href = url;
                link.style.display = 'none';
                link.download = ''; // Force download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setTimeout(() => {
                    showStatus('✅ ההורדה החלה בהצלחה!', 'success');
                    setTimeout(() => {
                        const status = document.getElementById('status');
                        if (status) status.style.display = 'none';
                    }, 3000);
                }, 500);

            } catch (error) {
                console.error('Download error:', error);
                showStatus('❌ שגיאה בהורדת הקובץ', 'error');
            }
        }

        // 🔧 NEW: Admin functions
        async function loadAdminOverview() {
            try {
                const response = await fetch(`${API_BASE}/admin/overview`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalUsers').textContent = data.totalUsers || 0;
                    document.getElementById('newUsersToday').textContent = data.newUsersToday || 0;
                    document.getElementById('totalTranscriptions').textContent = data.totalTranscriptions || 0;
                    document.getElementById('totalMinutesUsed').textContent = data.totalMinutesUsed || 0;
                }
            } catch (error) {
                console.error('Error loading admin overview:', error);
            }
        }

        async function loadAdminUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`);
                const data = await response.json();

                if (data.success) {
                    const tbody = document.getElementById('usersTableBody');
                    tbody.innerHTML = '';

                    data.users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${user.remainingMinutes}</td>
                            <td>${user.totalTranscribed}</td>
                            <td>${user.joinDate || 'לא זמין'}</td>
                            <td>
                                <button class="action-btn btn-success" onclick="addMinutesToUser('${user.email}', '${user.name}')">➕ הוסף דקות</button>
                                <button class="action-btn btn-edit" onclick="editUser('${user.email}')">✏️ ערוך</button>
                                ${!user.isAdmin ? `<button class="action-btn btn-delete" onclick="deleteUser('${user.email}')">🗑️ מחק</button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading admin users:', error);
            }
        }

        async function addMinutesToUser(userEmail, userName) {
            const minutes = prompt(`כמה דקות להוסיף למשתמש ${userName}?`, '60');

            if (minutes === null || minutes === '') {
                return; // User cancelled
            }

            const minutesToAdd = parseInt(minutes);
            if (isNaN(minutesToAdd) || minutesToAdd <= 0) {
                alert('אנא הזן מספר דקות תקין');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/add-minutes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        adminEmail: currentUser.email,
                        userEmail: userEmail,
                        minutes: minutesToAdd
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`✅ נוספו ${minutesToAdd} דקות למשתמש ${userName}`);
                    loadAdminUsers(); // Refresh the table
                } else {
                    alert(`❌ שגיאה: ${data.error}`);
                }
            } catch (error) {
                console.error('Error adding minutes:', error);
                alert('❌ שגיאה בהוספת דקות');
            }
        }

        // Placeholder for editUser function
        function editUser(userEmail) {
            alert('🚧 פונקציית עריכה בפיתוח');
        }

        async function loadAdminTranscriptions() {
            try {
                const response = await fetch(`${API_BASE}/admin/transcriptions`);
                const data = await response.json();

                if (data.success) {
                    const tbody = document.getElementById('transcriptionsTableBody');
                    tbody.innerHTML = '';

                    data.transcriptions.forEach(transcription => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${transcription.date}</td>
                            <td>${transcription.userEmail}</td>
                            <td>${transcription.fileName}</td>
                            <td>${transcription.duration} דקות</td>
                            <td>${getLanguageName(transcription.language)}</td>
                            <td><span class="status-badge status-${transcription.status}">${getStatusName(transcription.status)}</span></td>
                            <td>
                                ${transcription.downloadUrl ?
                                  `<button class="action-btn btn-edit" onclick="downloadFile('${transcription.downloadUrl}')">📥 הורד</button>` :
                                  '-'
                                }
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading admin transcriptions:', error);
            }
        }

        function editUser(email) {
            // Fill the add minutes form with user email
            document.getElementById('adminUserEmail').value = email;
            switchAdminTab('add-minutes');
        }

        async function deleteUser(email) {
            if (confirm(`האם אתה בטוח שברצונך למחוק את המשתמש ${email}?`)) {
                try {
                    const response = await fetch(`${API_BASE}/admin/delete-user`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            adminEmail: currentUser.email,
                            userEmail: email
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showStatus(`המשתמש ${email} נמחק בהצלחה`, 'success');
                        loadUsers(); // Refresh user list
                    } else {
                        showStatus(data.error || 'שגיאה במחיקת המשתמש', 'error');
                    }
                } catch (error) {
                    console.error('Delete user error:', error);
                    showStatus('שגיאה בחיבור לשרת', 'error');
                }
            }
        }

        // ========== Google Drive Integration ==========

        const GOOGLE_DRIVE_CONFIG = {
            CLIENT_ID: 'YOUR_GOOGLE_CLIENT_ID_HERE',
            API_KEY: '', // Will be loaded from server environment variables
            DISCOVERY_DOC: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
            SCOPES: 'https://www.googleapis.com/auth/drive.readonly'
        };

        let gapi_initialized = false;
        let google_auth_initialized = false;

        // Initialize Google APIs
        async function initializeGoogleAPIs() {
            try {
                console.log('🔗 Initializing Google APIs...');

                // Initialize gapi
                await new Promise((resolve, reject) => {
                    gapi.load('auth2:picker', resolve);
                });

                console.log('✅ Google APIs loaded');
                gapi_initialized = true;

            } catch (error) {
                console.error('❌ Failed to initialize Google APIs:', error);
                showStatus('שגיאה בטעינת Google Drive API', 'error');
            }
        }

        // Select files from Google Drive
        async function selectFromGoogleDrive() {
            try {
                if (!gapi_initialized) {
                    showStatus('טוען Google Drive API...', 'info');
                    await initializeGoogleAPIs();
                }

                // Authenticate user
                const authInstance = gapi.auth2.getAuthInstance();
                if (!authInstance.isSignedIn.get()) {
                    console.log('🔐 User not signed in, prompting for authentication...');
                    await authInstance.signIn();
                }

                console.log('✅ User authenticated with Google');

                // Create and show picker
                const picker = new google.picker.PickerBuilder()
                    .addView(google.picker.ViewId.DOCS)
                    .setOAuthToken(authInstance.currentUser.get().getAuthResponse().access_token)
                    .setCallback(handleGoogleDriveSelection)
                    .build();

                picker.setVisible(true);

            } catch (error) {
                console.error('❌ Google Drive selection failed:', error);
                showStatus('שגיאה בחיבור ל-Google Drive', 'error');
            }
        }

        // Handle file selection from Google Drive
        function handleGoogleDriveSelection(data) {
            if (data.action === google.picker.Action.PICKED) {
                const files = data.docs;
                console.log('📁 Selected files from Google Drive:', files);

                // Process selected files
                processGoogleDriveFiles(files);
            }
        }

        // Process Google Drive files
        async function processGoogleDriveFiles(driveFiles) {
            try {
                showStatus('מעבד קבצים מ-Google Drive...', 'info');

                const audioVideoFiles = driveFiles.filter(file => {
                    const mimeType = file.mimeType || '';
                    return mimeType.startsWith('audio/') || mimeType.startsWith('video/');
                });

                if (audioVideoFiles.length === 0) {
                    showStatus('לא נמצאו קבצי אודיו או וידאו בבחירה', 'error');
                    return;
                }

                console.log(`📎 Found ${audioVideoFiles.length} audio/video files`);

                // Add files to selection (convert to File-like objects)
                const fileObjects = audioVideoFiles.map(driveFile => ({
                    name: driveFile.name,
                    size: driveFile.sizeBytes || 0,
                    type: driveFile.mimeType || '',
                    driveId: driveFile.id,
                    isGoogleDriveFile: true
                }));

                // Add to selectedFiles array
                selectedFiles.push(...fileObjects);
                updateSelectedFilesDisplay();
                updateCostEstimate();

                showStatus(`נוספו ${audioVideoFiles.length} קבצים מ-Google Drive`, 'success');

            } catch (error) {
                console.error('❌ Error processing Google Drive files:', error);
                showStatus('שגיאה בעיבוד קבצי Google Drive', 'error');
            }
        }

        // Initialize Google APIs when page loads
        window.addEventListener('load', async () => {
            // Check for stored user first
            if (!(await checkStoredUser())) {
                // Only show auth interface if no stored user
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('appSection').style.display = 'none';
            }

            // Check cookie consent after user state is determined
            checkCookieConsent();

            initializeGoogleAPIs();
            testAPI();
        });

        // Initialize app
        updateSubmitButton();
    </script>
</body>
</html>






