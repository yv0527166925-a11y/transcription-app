// בדיקת התיקונים הסופיים לבעיות עבריות
function testFinalHebrewFixes() {
  console.log('🧪 Testing final Hebrew text fixes...');

  const problemText = `שליט" א  אמינים האר'י ז" ל חז "לים ב "צילא דמהימנותא" הוא יפרע ממי שאינו עומד בדיבורו." ה "אור החיים" העילוי של הישיבה הוא בדף ל', אתה בק" ב.`;

  console.log('לפני תיקון:');
  console.log(problemText);

  // העתק הקוד המתוקן מהשרת - גרסה עדכנית
  let text = problemText;

  // קודם כל - נקה את כל הגרשיים לסוג אחיד
  text = text.replace(/["\u0022\u201C\u201D]/g, '"');

  // **שלב א: תיקון קיצורים נפוצים - ללא פשרות**
  const hebrewAbbreviations = [
    ['רש', 'י'], ['חז', 'ל'], ['שליט', 'א'], ['החיד', 'א'],
    ['הגר', 'א'], ['רמב', 'ם'], ['רמב', 'ן'], ['משנ', 'ב'],
    ['שו', 'ע'], ['שו', 'ת'], ['מהר', 'ל'], ['בק', 'ב'],
    ['ב', 'ה'], ['ד', 'ה']
  ];

  hebrewAbbreviations.forEach(([first, second]) => {
    const patterns = [
      `${first}\\s*"\\s*${second}`,    // רש " י
      `${first}\\s+"\\s*${second}`,    // רש  " י
      `${first}"\\s*${second}`,        // רש" י
      `${first}\\s*"${second}`,        // רש "י
      `${first}"${second}`             // רש"י (כבר נכון)
    ];
    patterns.forEach(pattern => {
      const regex = new RegExp(pattern, 'g');
      text = text.replace(regex, `${first}"${second}`);
    });
  });

  // תיקון מיוחד למילים מחוברות ונפרדות
  text = text
    .replace(/האר['׳]\s*י\s+ז\s*"\s*ל/g, 'האר"י ז"ל')
    .replace(/ר['׳]\s/g, 'ר\' ')
    .replace(/ר"/g, 'ר\'')

    // תיקון מילים שמתחלקות עם גרשיים
    .replace(/חז\s*"\s*לים/g, 'חז"לים')      // חז "לים -> חז"לים
    .replace(/חז\s+"\s*לים/g, 'חז"לים')     // חז  "לים -> חז"לים
    .replace(/חכמי\s*"\s*ם/g, 'חכמים')
    .replace(/אמיני\s*ם/g, 'אמנים')

    // תיקון מיתוקים שגויים במילים עבריות
    .replace(/אמן-ים/g, 'אמנים')
    .replace(/בן-אדם/g, 'בן אדם')
    .replace(/יהודי-ים/g, 'יהודים')
    .replace(/תלמיד-ים/g, 'תלמידים')

    // תיקון גרשיים וציטוטים מתקדם - פתרון חזק וסופי
    // שלב 1: נקה סוגי גרשיים שונים לאחיד
    .replace(/["\u0022\u201C\u201D]/g, '"')

    // שלב 2: תקן גרשיים כפולים סביב שמות (ה "אוהב ישראל" -> ה"אוהב ישראל")
    .replace(/ה\s+"([^"]+)"/g, 'ה"$1"')            // ה "שם" -> ה"שם"
    .replace(/([א-ת])\s+"([^"]+)"/g, '$1"$2"')     // מילה "שם" -> מילה"שם"

    // שלב 3: הוסף רווחים לפני גרשיים שצמודים למילים עבריות (רק לציטוטים)
    .replace(/([א-ת])"([א-ת][^"]*[א-ת])"([.,!?\s])/g, '$1 "$2"$3')  // ציטוטים ארוכים
    .replace(/([א-ת])"([א-ת]{2,})/g, (match, before, after) => {
      // שמור קיצורים עבריים מוכרים
      const abbreviations = ['לים', 'לי', 'לין', 'לנו', 'ל', 'ם', 'ן', 'א', 'י', 'ב', 'ה', 'ע', 'ת'];
      if (abbreviations.some(abbr => after.startsWith(abbr))) {
        return match; // השאר כמו שזה
      }
      return before + ' "' + after; // הוסף רווח
    })

    // שלב 8: תקן פיסוק אחרי גרשיים שצמוד לא נכון
    .replace(/([א-ת])"\.\s*"/g, '$1."')           // בדיבורו." -> בדיבורו."
    .replace(/([א-ת])"\.\s*]/g, '$1."]')          // עם סוגריים
    .replace(/([א-ת])"\,/g, '$1",')               // פסיק אחרי גרשיים
    .replace(/([א-ת])"!/g, '$1"!')                // קריאה אחרי גרשיים
    .replace(/([א-ת])"\?/g, '$1"?')               // שאלה אחרי גרשיים

    // תיקון פיסוק חזק יותר - הסרת רווחים לפני פיסוק
    .replace(/\s+([.,!?:;])/g, '$1')              // הסר כל רווח לפני פיסוק
    .replace(/([.,!?:;])\s+/g, '$1 ')             // רווח יחיד אחרי פיסוק

    // ניקוי רווחים מיותרים
    .replace(/\s{2,}/g, ' ')                      // רווחים כפולים לרווח יחיד
    .replace(/^\s+|\s+$/gm, '')                   // רווחים בתחילת/סוף שורות
    .trim();

  console.log('\nאחרי תיקון:');
  console.log(text);

  console.log('\n=== ציפיות ===');
  console.log('✅ שליט"א (ללא רווח)');
  console.log('✅ אמנים (לא אמינים)');
  console.log('✅ האר"י ז"ל (ללא רווחים)');
  console.log('✅ חז"לים (לא חז "לים)');
  console.log('✅ בדיבורו." (פיסוק נכון)');
  console.log('✅ ה"אור החיים" (ללא רווח)');
  console.log('✅ בק"ב (ללא רווח)');
}

testFinalHebrewFixes();